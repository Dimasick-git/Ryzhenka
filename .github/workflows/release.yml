name: üöÄ Auto Release & Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 5.0.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - beta
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip

      - name: üî® Build project
        run: |
          # –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ —Å –ø—Ä–æ–µ–∫—Ç–æ–º
          zip -r Ryazhenka-${{ github.event.inputs.version }}.zip \
            --exclude "*.git*" \
            --exclude ".github/*" \
            --exclude "node_modules/*" \
            --exclude ".env*" \
            .

      - name: üìä Generate checksums
        run: |
          sha256sum Ryazhenka-${{ github.event.inputs.version }}.zip > checksums.txt
          cat checksums.txt

      - name: üìù Parse changelog
        id: changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ CHANGELOG.md –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          python3 << 'EOF'
          import re
          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # –ò—â–µ–º –≤–µ—Ä—Å–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ ## [X.Y.Z]
          pattern = rf'## \[\d+\.\d+\.\d+\].*?(?=## \[|$)'
          match = re.search(pattern, content, re.DOTALL)
          
          if match:
              section = match.group(0).strip()
              # –û—á–∏—â–∞–µ–º –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
              changelog_items = '\n'.join(line.strip() for line in section.split('\n')[1:] if line.strip())
              print(changelog_items)
          EOF

      - name: üéØ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: "ü•õ Ryazhenka v${{ github.event.inputs.version }}"
          body: |
            # ü•õ Ryazhenka v${{ github.event.inputs.version }}

            ## üìã Release Type
            - **Type**: ${{ github.event.inputs.release_type }}
            - **Date**: $(date '+%Y-%m-%d')

            ## üì¶ Downloads
            - **Main Build**: [Ryazhenka-${{ github.event.inputs.version }}.zip](https://github.com/Dimasick-git/Ryzhenka/releases/download/v${{ github.event.inputs.version }}/Ryazhenka-${{ github.event.inputs.version }}.zip)

            ## üîê Checksums (SHA256)
            ```
            $(cat checksums.txt)
            ```

            ## ‚ú® What's New
            See [CHANGELOG.md](https://github.com/Dimasick-git/Ryzhenka/blob/main/CHANGELOG.md) for full details.

            ## üîó Quick Links
            - üìñ [Installation Guide](https://github.com/Dimasick-git/Ryzhenka/blob/main/INSTALL.md)
            - üí¨ [Telegram Community](https://t.me/Ryazhenkacfw)
            - üì∫ [YouTube Channel](https://www.youtube.com/@Dimaick-git)
            - üåê [Official Website](https://dimasick-git.github.io/Ryzhenka/)

            ## üìö Related Components
            - üéÆ [Ryazhahand-Overlay](https://github.com/Dimasick-git/Ryazhahand-Overlay)
            - ‚ö° [Sys-clk-for-RYZ](https://github.com/Ryazhenka-Helper-1/Sys-clk-for-RYZ)
            - üöÄ [Atmosphere](https://github.com/Atmosphere-NX/Atmosphere)

            ## üìù Notes
            - Always backup your data before installing
            - Follow the installation guide carefully
            - Report issues on [GitHub Issues](https://github.com/Dimasick-git/Ryzhenka/issues)

          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'beta' }}

      - name: üì§ Upload assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Ryazhenka-${{ github.event.inputs.version }}.zip
          asset_name: Ryazhenka-${{ github.event.inputs.version }}.zip
          asset_content_type: application/zip

      - name: üì§ Upload checksums
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./checksums.txt
          asset_name: checksums.txt
          asset_content_type: text/plain

      - name: üîî Notify on completion
        run: |
          echo "‚úÖ Release v${{ github.event.inputs.version }} created successfully!"
          echo "üì¶ Build artifacts uploaded to GitHub Releases"
          echo "üîó Release URL: https://github.com/Dimasick-git/Ryzhenka/releases/tag/v${{ github.event.inputs.version }}"
