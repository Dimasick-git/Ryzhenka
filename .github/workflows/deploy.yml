name: ğŸš€ Deploy to Main

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to merge into main'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - staging
      merge_type:
        description: 'Merge type'
        required: true
        default: 'squash'
        type: choice
        options:
          - merge
          - squash
          - rebase

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“Š Get version
        id: version
        run: |
          VERSION=$(head -n 5 CHANGELOG.md | grep -oP '\[\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Deploying version: $VERSION"

      - name: ğŸ”„ Fetch all branches
        run: |
          git fetch origin main
          git fetch origin ${{ github.event.inputs.branch }}

      - name: ğŸŒ³ Switch to main
        run: git checkout main

      - name: ğŸ”€ Merge branch
        run: |
          echo "Merging ${{ github.event.inputs.branch }} into main using ${{ github.event.inputs.merge_type }} strategy..."
          git merge origin/${{ github.event.inputs.branch }} --${{ github.event.inputs.merge_type }} -m "ğŸ”„ Deploy v${{ steps.version.outputs.version }} from ${{ github.event.inputs.branch }}"

      - name: ğŸ“ Update CHANGELOG timestamp
        run: |
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ñ€ĞµĞ»Ğ¸Ğ·Ğ° Ğ² CHANGELOG
          sed -i "s/## \[\(.*\)\].*/## [\1] â€” $(date '+%Y-%m-%d')/g" CHANGELOG.md
          git add CHANGELOG.md
          git commit --amend --no-edit || true

      - name: ğŸ“¤ Push to main
        run: |
          git push origin main

      - name: ğŸ·ï¸ Create tag
        run: |
          git tag -a v${{ steps.version.outputs.version }} -m "Release v${{ steps.version.outputs.version }}" || true
          git push origin v${{ steps.version.outputs.version }} || true

      - name: ğŸ“¢ Create release notification PR (optional)
        uses: actions/github-script@v6
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const branch = '${{ github.event.inputs.branch }}';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ v${version} deployed to main`,
              body: `
## ğŸš€ Deployment Successful

**Version**: \`v${version}\`
**Merged from**: \`${branch}\`
**Merge strategy**: \`${{ github.event.inputs.merge_type }}\`
**Date**: ${new Date().toISOString()}

### âœ… Deployment Steps
- [x] Code merged to \`main\`
- [x] Tag created: \`v${version}\`
- [x] Changelog updated

### ğŸ“‹ Next Steps
1. Review the [release page](https://github.com/Dimasick-git/Ryzhenka/releases)
2. Announce on Telegram and YouTube
3. Monitor for any issues

### ğŸ”— Related Links
- [Main branch](https://github.com/Dimasick-git/Ryzhenka/tree/main)
- [Commits since last release](https://github.com/Dimasick-git/Ryzhenka/commits/main)
- [Releases](https://github.com/Dimasick-git/Ryzhenka/releases)
              `
            })

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Deployment to main successful!"
          echo "ğŸ“Œ Version: v${{ steps.version.outputs.version }}"
          echo "ğŸ”€ Merged from: ${{ github.event.inputs.branch }}"
          echo "ğŸ“Š Merge type: ${{ github.event.inputs.merge_type }}"
          echo "ğŸ”— Repository: https://github.com/${{ github.repository }}"
