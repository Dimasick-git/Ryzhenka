<!DOCTYPE html>
<html lang="ru" data-theme="glow" data-bg="dark" data-text="default">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ryazhenka — CFW</title>
  <link rel="icon" href="./assets/Ryazhalogo.png" />
  <style>
    :root{
      --bg-dark:#05060a;
      --bg-light:#ffffff;
      --panel-dark:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --panel-light:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01));
      --accent:#7c5cff;
      --muted:#9aa0a6;
      --card-bg: rgba(255,255,255,0.02);
      --text-light:#e7eef6;
      --text-dark:#0b1220;
      --success:#3bd671;
      --danger:#ff6b6b;
    }

    html[data-theme='glow']{ --accent:#7c5cff; }
    html[data-theme='classic']{ --accent:#6ee7b7; }
    html[data-theme='cyber']{ --accent:#00e6ff; }
    html[data-theme='sunset']{ --accent:#ff9f7a; }
    html[data-theme='matrix']{ --accent:#4cff4c; }

    html[data-bg='dark']{ background: radial-gradient(1200px 400px at 10% 10%, rgba(124,92,255,0.06), transparent), var(--bg-dark); color: var(--text-light); --panel:var(--panel-dark); --card-bg: rgba(255,255,255,0.02); }
    html[data-bg='light']{ background: var(--bg-light); color: var(--text-dark); --panel:var(--panel-light); --card-bg: rgba(0,0,0,0.03); }

    html[data-text='default']{ --muted:#9aa0a6; }
    html[data-text='alt']{ --muted:#7c6e5a; }
    html[data-text='high']{ --muted:#444; }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;font-size:15px;line-height:1.4}
    .wrap{max-width:1200px;margin:0 auto;padding:1rem}
    header.top{padding:1rem 0}
    .brand{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .brand-left{display:flex;align-items:center;gap:0.75rem}
    .logo{width:56px;height:56px;border-radius:10px;cursor:pointer}
    .title{font-weight:700;font-size:1.15rem}

    .controls-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}

    .panel{background:var(--panel);padding:1rem;border-radius:12px}
    .hero{display:grid;grid-template-columns:1fr 360px;gap:1rem;padding:1.5rem;border-radius:12px;align-items:start}
    .cta{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.45rem .6rem;border-radius:8px;color:inherit;text-decoration:none;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#39d6ff);border:0;color:#0b0e12;font-weight:700}
    .muted{color:var(--muted)}

    input[type="text"], input[type="date"], select, textarea{padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    textarea{resize:vertical}

    .releases{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-top:1rem}
    .release-card{background:var(--card-bg);padding:1rem;border-radius:12px;display:flex;flex-direction:column;gap:.5rem;min-height:170px;border:1px solid rgba(255,255,255,0.02)}
    .release-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;background:#05060a}
    .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:.85rem}

    .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:0.75rem}
    .gallery img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer;transition:transform .18s ease}
    .gallery img:hover{transform:translateY(-6px) scale(1.02)}

    .crew-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
    .crew-card{display:flex;gap:.75rem;align-items:center;padding:.6rem;border-radius:10px;background:var(--card-bg)}
    .crew-card img{width:64px;height:64px;border-radius:10px;object-fit:cover}

    /* ToDo */
    .todo{display:grid;grid-template-columns:1fr 320px;gap:1rem}
    .todo-list{padding:0;margin:0;list-style:none;max-height:480px;overflow:auto}
    .todo-item{display:flex;align-items:center;gap:.5rem;padding:.5rem;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:.5rem;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}
    .todo-item .meta{font-size:.85rem;color:var(--muted)}
    .todo-item.completed{opacity:.6;text-decoration:line-through}

    .tag{padding:.15rem .4rem;border-radius:6px;background:rgba(0,0,0,0.12);font-size:.75rem}

    footer{margin-top:2rem;padding:1rem 0;color:var(--muted)}

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .todo{grid-template-columns:1fr}
      .wrap{padding:.75rem}
    }
  </style>
</head>
<body>
  <header class="top">
    <div class="wrap brand">
      <div class="brand-left">
        <img alt="Ryazhenka" class="logo" src="./assets/Ryazhalogo.png" onclick="location.href='./'" />
        <div>
          <div class="title">Ryazhenka</div>
          <div class="muted" style="font-size:.85rem">CFW — минималистичный интерфейс</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:.5rem">
        <div class="controls-row" aria-hidden="false">
          <label class="muted" for="themePicker" style="margin-right:6px">Тема</label>
          <select id="themePicker" aria-label="Выбор темы">
            <option value="glow">Glow</option>
            <option value="classic">Classic</option>
            <option value="cyber">Cyber</option>
            <option value="sunset">Sunset</option>
            <option value="matrix">Matrix</option>
          </select>

          <label class="muted" for="bgMode" style="margin-left:10px;margin-right:6px">Фон</label>
          <select id="bgMode" aria-label="Фон">
            <option value="dark">Темный</option>
            <option value="light">Светлый</option>
          </select>

          <label class="muted" for="textMode" style="margin-left:10px;margin-right:6px">Текст</label>
          <select id="textMode" aria-label="Цвет текста">
            <option value="default">По умолчанию</option>
            <option value="alt">Альт</option>
            <option value="high">Высокая контрастность</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero panel" aria-labelledby="hero-title">
      <div>
        <h1 id="hero-title">Ryazhenka</h1>
        <p class="muted" style="margin-top:.5rem">Упрощённый интерфейс и новые функции.</p>
        <div class="cta" style="margin-top:.5rem">
          <a class="btn primary" href="#todo">To‑Do</a>
          <a class="btn" href="#changelog">Релизы</a>
          <a class="btn" href="#crew">Экипаж</a>
          <a class="btn" href="#gallery">Галерея</a>
        </div>
      </div>

      <aside>
        <div class="panel" style="margin-bottom:.75rem">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Быстрые</strong>
            <button class="btn" id="refreshAll" title="Обновить все данные">Обновить</button>
          </div>
          <div class="muted" style="margin-top:.5rem;font-size:.9rem">Релизы и экипаж получаем из Dimasick-git/Ryzhenka</div>
        </div>

        <div class="panel">
          <strong>Ссылки</strong>
          <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem">
            <a class="btn" href="https://github.com/Dimasick-git/Ryzhenka/releases" target="_blank">Релизы</a>
            <a class="btn" href="https://github.com/Dimasick-git/Ryzhenka/graphs/contributors" target="_blank">Contributors</a>
          </div>
        </div>
      </aside>
    </section>

    <!-- Releases -->
    <section class="panel" id="changelog" aria-labelledby="releases-title">
      <h2 id="releases-title" style="margin:0">История изменений / Релизы</h2>

      <div style="margin-top:.75rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap">
        <div class="controls-row">
          <input id="searchReleases" class="search" placeholder="Поиск (версия, название, описание)" aria-label="Поиск релизов" />
          <select id="filterType" class="select" aria-label="Фильтр по типу">
            <option value="all">Все типы</option>
            <option value="Ryazhenkabestcfw">BestCFW</option>
            <option value="Ryazhenka_AIO">AIO</option>
            <option value="Ryazhenka_lite">Lite</option>
          </select>
          <select id="sortBy" class="select" aria-label="Сортировка">
            <option value="date_desc">По дате (новые сначала)</option>
            <option value="date_asc">По дате (старые сначала)</option>
            <option value="downloads_desc">По загрузкам</option>
          </select>
        </div>

        <div style="text-align:right">
          <div class="muted">Найдено: <span id="releasesCount">0</span> • Статус: <span id="fetchStatus">—</span></div>
          <div id="statsBlock" class="muted" style="margin-top:.35rem;font-size:.9rem"></div>
        </div>
      </div>

      <div class="releases" id="releases-list" aria-live="polite" style="margin-top:1rem"></div>
    </section>

    <!-- Gallery -->
    <section class="panel" id="gallery">
      <h2 style="margin:0">Галерея</h2>
      <div class="gallery" id="galleryGrid" style="margin-top:.75rem"></div>
    </section>

    <!-- Crew -->
    <section class="panel" id="crew">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Стена экипажа</h2>
        <div>
          <button class="btn" id="addManualCrewBtn">Добавить участника</button>
        </div>
      </div>

      <div class="crew-grid" id="crew-grid" style="margin-top:.75rem"></div>
    </section>

    <!-- To-Do -->
    <section class="panel" id="todo">
      <h2 style="margin:0">To‑Do (локально)</h2>

      <div class="todo" style="margin-top:.75rem">
        <div>
          <div style="display:flex;gap:.5rem;margin-bottom:.5rem">
            <input id="todoInput" placeholder="Название задачи" class="search" aria-label="Новая задача" />
            <select id="todoPriority" class="select" aria-label="Приоритет">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="low">Low</option>
            </select>
            <input id="todoDue" type="date" aria-label="Дата выполнения" />
            <button class="btn primary" id="todoAdd">Добавить</button>
          </div>

          <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem">
            <input id="todoFilter" placeholder="Фильтр" class="search" />
            <select id="todoSort" class="select">
              <option value="new">Новые сначала</option>
              <option value="old">Старые сначала</option>
              <option value="prio">По приоритету</option>
              <option value="due">По дате</option>
            </select>
            <button class="btn" id="exportTodos">Экспорт</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <button class="btn" id="importTodosBtn">Импорт</button>
          </div>

          <ul id="todoList" class="todo-list" aria-live="polite"></ul>
        </div>

        <div style="padding:.5rem;border-left:1px solid rgba(255,255,255,0.03);min-width:220px">
          <h4 style="margin-top:0">Управление</h4>
          <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem">
            <button class="btn" id="clearCompleted">Удалить выполненные</button>
            <button class="btn" id="clearAll">Удалить все</button>
            <button class="btn" id="bulkComplete">Отметить всё выполненным</button>
            <div class="muted" style="font-size:.9rem">Данные сохраняются в браузере (localStorage).</div>
          </div>
        </div>

      </div>
    </section>

    <section class="panel" id="install" style="margin-top:1rem">
      <h2 style="margin:0">Установка</h2>
      <div class="muted" style="margin-top:.5rem">Скачайте релиз и распакуйте на microSD.</div>
    </section>

  </main>

  <footer>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
      <div class="muted">© Ryazhenka — crew.ecosystem</div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <a class="btn" href="https://t.me/Ryazhenkabestcfw" target="_blank">Telegram</a>
        <a class="btn" href="https://github.com/Dimasick-git/Ryzhenka" target="_blank">Source</a>
      </div>
    </div>
  </footer>

  <!-- Modal container -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:999;padding:1rem"></div>

  <script>
    // ----- Settings & utilities -----
    const owner = 'Dimasick-git';
    const repo = 'Ryzhenka';
    const releasesApi = `https://api.github.com/repos/${owner}/${repo}/releases?per_page=100`;
    const contributorsApi = `https://api.github.com/repos/${owner}/${repo}/contributors?per_page=100`;
    const doc = document.documentElement;

    function applySettings(){
      const theme = localStorage.getItem('rz_theme') || 'glow';
      const bg = localStorage.getItem('rz_bg') || 'dark';
      const text = localStorage.getItem('rz_text') || 'default';
      doc.dataset.theme = theme;
      doc.dataset.bg = bg;
      doc.dataset.text = text;
      document.getElementById('themePicker').value = theme;
      document.getElementById('bgMode').value = bg;
      document.getElementById('textMode').value = text;
    }
    document.getElementById('themePicker').addEventListener('change', e => { localStorage.setItem('rz_theme', e.target.value); applySettings(); });
    document.getElementById('bgMode').addEventListener('change', e => { localStorage.setItem('rz_bg', e.target.value); applySettings(); });
    document.getElementById('textMode').addEventListener('change', e => { localStorage.setItem('rz_text', e.target.value); applySettings(); });
    applySettings();

    function fmtDate(iso){ if(!iso) return ''; try{ return new Date(iso).toLocaleDateString(); }catch(e){ return iso } }
    function bbootLogoUrl(version){ return `https://github.com/${owner}/${repo}/releases/download/${encodeURIComponent(version)}/bbootlogo.png`; }

    // ----- Releases -----
    let releases = [];
    const listEl = document.getElementById('releases-list');
    const galleryGrid = document.getElementById('galleryGrid');

    function makeReleaseCard(r){
      const card = document.createElement('article');
      card.className = 'release-card';
      const ver = r.tag_name || r.name || '';
      const img = document.createElement('img');
      img.alt = `Лого ${ver}`;
      img.loading = 'lazy';
      const basset = (r.assets||[]).find(a => /bbootlogo/i.test(a.name));
      img.src = basset ? basset.browser_download_url : (r.assets && r.assets[0] && r.assets[0].browser_download_url) || bbootLogoUrl(ver);
      card.appendChild(img);

      const h3 = document.createElement('h3');
      h3.textContent = r.name || ver;
      card.appendChild(h3);

      const meta = document.createElement('div'); meta.className = 'meta';
      const date = document.createElement('span'); date.textContent = fmtDate(r.published_at || r.created_at);
      const vspan = document.createElement('span'); vspan.textContent = ver;
      meta.appendChild(date); meta.appendChild(vspan);
      card.appendChild(meta);

      if(r.body){
        const p = document.createElement('p'); p.textContent = r.body.length > 240 ? r.body.slice(0,240) + '…' : r.body;
        card.appendChild(p);
      }

      const btnWrap = document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='.5rem';
      if(r.html_url){ const a = document.createElement('a'); a.className='btn'; a.href = r.html_url; a.target='_blank'; a.textContent='Открыть'; btnWrap.appendChild(a); }
      card.appendChild(btnWrap);
      return card;
    }

    async function loadReleases(){
      document.getElementById('fetchStatus').textContent = 'загрузка';
      listEl.innerHTML = '';
      galleryGrid.innerHTML = '';
      releases = [];
      try{
        const res = await fetch(releasesApi);
        if(!res.ok) throw new Error('fetch releases failed');
        const data = await res.json();
        releases = (Array.isArray(data) ? data : []).sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at));
      }catch(e){
        console.warn('releases error', e);
        // keep releases empty
      }
      renderReleases();
      renderGallery();
      computeStats();
      document.getElementById('fetchStatus').textContent = 'ok';
    }

    function renderReleases(){
      const q = (document.getElementById('searchReleases')||{}).value || '';
      const type = (document.getElementById('filterType')||{}).value || 'all';
      const sortBy = (document.getElementById('sortBy')||{}).value || 'date_desc';
      let filtered = releases.filter(r=>{
        const combined = [(r.tag_name||''),(r.name||''),(r.body||'')].join(' ').toLowerCase();
        const qOk = !q || combined.includes(q.toLowerCase());
        let typeOk = true;
        if(type !== 'all') typeOk = (r.assets||[]).some(a => a.name && a.name.toLowerCase().includes(type.toLowerCase()));
        return qOk && typeOk;
      });
      if(sortBy === 'date_desc') filtered.sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at));
      if(sortBy === 'date_asc') filtered.sort((a,b)=> new Date(a.published_at||a.created_at) - new Date(b.published_at||b.created_at));
      if(sortBy === 'downloads_desc') filtered.sort((a,b)=>{
        const sa = (a.assets||[]).reduce((s,x)=> s + (x.download_count||0), 0);
        const sb = (b.assets||[]).reduce((s,x)=> s + (x.download_count||0), 0);
        return sb - sa;
      });

      document.getElementById('releasesCount').textContent = filtered.length;
      listEl.innerHTML = '';
      // per user request: minimal extra text, don't show "no results" explanation, but keep count/status
      filtered.forEach(r => listEl.appendChild(makeReleaseCard(r)));
    }

    function renderGallery(){
      galleryGrid.innerHTML = '';
      releases.forEach(r=>{
        const ver = r.tag_name || r.name || '';
        const assets = r.assets || [];
        const chosen = assets.find(a=>/\.(gif|webp|png|jpe?g)$/i.test(a.name||'')) || assets[0];
        const src = chosen ? chosen.browser_download_url : bbootLogoUrl(ver);
        const img = document.createElement('img');
        img.src = src;
        img.alt = ver;
        img.loading = 'lazy';
        galleryGrid.appendChild(img);
      });
    }

    function computeStats(){
      let total = 0;
      let ownerTotal = 0;
      releases.forEach(r => (r.assets||[]).forEach(a => { if(typeof a.download_count === 'number'){ total += a.download_count; } }));
      const sb = document.getElementById('statsBlock');
      sb.innerHTML = `⬇️ Всего загрузок (публично): <strong>${total}</strong>`;
    }

    document.getElementById('searchReleases').addEventListener('input', renderReleases);
    document.getElementById('filterType').addEventListener('change', renderReleases);
    document.getElementById('sortBy').addEventListener('change', renderReleases);

    // ----- Crew: manual + contributors fallback -----
    const manualCrew = [
      { login: 'Dimasick-git', name: 'Dimasick-git', role: 'Основатель — координатор' },
      { login: 'Ryazhenka-Helper-1', name: 'Ryazhenka-Helper-1', role: 'Создатель модулей' },
      { login: 'Ryazhenka-Helper-01', name: 'Ryazhenka-Helper-01', role: 'Помощник (видео, тесты)' }
    ];
    const crewGrid = document.getElementById('crew-grid');

    function makeCrewCard(p){
      const card = document.createElement('div'); card.className = 'crew-card';
      const img = document.createElement('img'); img.src = p.avatar || `https://github.com/${p.login}.png`; img.alt = p.login; card.appendChild(img);
      const info = document.createElement('div');
      const name = document.createElement('div'); const link = document.createElement('a'); link.href = `https://github.com/${p.login}`; link.target='_blank'; link.textContent = p.login; link.style.fontWeight = '700'; name.appendChild(link);
      if(p.name && p.name !== p.login) name.appendChild(document.createTextNode(' — ' + p.name));
      info.appendChild(name);
      if(p.role){ const role = document.createElement('div'); role.className='muted'; role.textContent = p.role; info.appendChild(role); }
      const contrib = document.createElement('div'); contrib.className='muted'; contrib.textContent = `Commits: ${p.contributions || 0}`; info.appendChild(contrib);
      card.appendChild(info);
      return card;
    }

    async function loadCrew(){
      crewGrid.innerHTML = '';
      // show manual first
      manualCrew.forEach(m => crewGrid.appendChild(makeCrewCard(m)));
      // try to fetch contributors and add new ones
      try{
        const res = await fetch(contributorsApi);
        if(!res.ok) throw new Error('contributors fetch failed');
        const list = await res.json();
        const manualSet = new Set(manualCrew.map(x => x.login.toLowerCase()));
        list.forEach(c => { if(!manualSet.has(c.login.toLowerCase())) crewGrid.appendChild(makeCrewCard({ login: c.login, avatar: c.avatar_url, contributions: c.contributions })); });
      }catch(e){
        // fail silently — manualCrew remains
        console.warn('contributors error', e);
      }
    }

    // UI to add manual crew entry (stored in localStorage so user can edit UI without editing file)
    document.getElementById('addManualCrewBtn').addEventListener('click', () => {
      openModal(`
        <div style="max-width:560px;background:var(--card-bg);padding:12px;border-radius:8px">
          <h3>Добавить участника</h3>
          <div style="display:grid;gap:.5rem">
            <input id="mc_login" placeholder="login (github)" />
            <input id="mc_name" placeholder="имя (опционально)" />
            <input id="mc_role" placeholder="роль (например: тестирование)" />
            <div style="display:flex;gap:.5rem;justify-content:flex-end">
              <button id="mc_cancel" class="btn">Отмена</button>
              <button id="mc_save" class="btn primary">Сохранить</button>
            </div>
          </div>
        </div>
      `);
      document.getElementById('mc_cancel').addEventListener('click', closeModal);
      document.getElementById('mc_save').addEventListener('click', () => {
        const login = document.getElementById('mc_login').value.trim();
        const name = document.getElementById('mc_name').value.trim();
        const role = document.getElementById('mc_role').value.trim();
        if(!login) { alert('Введите login'); return; }
        const saved = JSON.parse(localStorage.getItem('rz_manual_crew') || '[]');
        saved.unshift({ login, name: name || login, role });
        localStorage.setItem('rz_manual_crew', JSON.stringify(saved));
        closeModal();
        refreshCrewFromStorage();
      });
    });

    function refreshCrewFromStorage(){
      const stored = JSON.parse(localStorage.getItem('rz_manual_crew') || '[]');
      // rebuild crewGrid with stored manual entries first, then default manualCrew, then contributors
      crewGrid.innerHTML = '';
      stored.forEach(m => crewGrid.appendChild(makeCrewCard(m)));
      manualCrew.forEach(m => crewGrid.appendChild(makeCrewCard(m)));
      // contributors appended asynchronously by loadCrew (we will call it)
      fetch(contributorsApi).then(r=> r.ok? r.json(): []).then(list=>{
        const seen = new Set([...(stored||[]).map(x=>x.login.toLowerCase()), ...manualCrew.map(x=>x.login.toLowerCase())]);
        list.forEach(c => { if(!seen.has(c.login.toLowerCase())) crewGrid.appendChild(makeCrewCard({ login: c.login, avatar: c.avatar_url, contributions: c.contributions })); });
      }).catch(()=>{});
    }

    // ----- Modal helpers -----
    const modalContainer = document.getElementById('modal');
    function openModal(html){
      modalContainer.innerHTML = '';
      modalContainer.style.display = 'flex';
      const wrapper = document.createElement('div');
      wrapper.style.maxWidth = '900px';
      wrapper.style.width = '100%';
      wrapper.style.borderRadius = '10px';
      wrapper.innerHTML = html;
      modalContainer.appendChild(wrapper);
      modalContainer.addEventListener('click', modalClickHandler);
    }
    function closeModal(){ modalContainer.style.display = 'none'; modalContainer.innerHTML = ''; modalContainer.removeEventListener('click', modalClickHandler); }
    function modalClickHandler(e){ if(e.target === modalContainer) closeModal(); }

    // ----- ToDo app (advanced) -----
    const todoKey = 'rz_todos_v2';
    let todos = [];

    function loadTodos(){
      try{ todos = JSON.parse(localStorage.getItem(todoKey) || '[]'); }catch(e){ todos = []; }
      renderTodos();
    }
    function saveTodos(){ localStorage.setItem(todoKey, JSON.stringify(todos)); renderTodos(); }
    function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }

    function renderTodos(){
      const ul = document.getElementById('todoList'); ul.innerHTML = '';
      const filter = (document.getElementById('todoFilter')||{}).value || '';
      const sortBy = (document.getElementById('todoSort')||{}).value || 'new';
      let list = todos.slice();
      if(filter) list = list.filter(t => (t.text + ' ' + (t.tags||'')).toLowerCase().includes(filter.toLowerCase()));
      if(sortBy === 'new') list.sort((a,b)=> b.ts - a.ts);
      if(sortBy === 'old') list.sort((a,b)=> a.ts - b.ts);
      if(sortBy === 'prio') {
        const map = { high: 2, normal: 1, low: 0 };
        list.sort((a,b)=> (map[b.priority]||0) - (map[a.priority]||0));
      }
      if(sortBy === 'due'){
        list.sort((a,b)=> (a.due? new Date(a.due).getTime(): Infinity) - (b.due? new Date(b.due).getTime(): Infinity));
      }

      list.forEach((t,i)=>{
        const li = document.createElement('li'); li.className = 'todo-item' + (t.done? ' completed':'');
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!t.done; chk.addEventListener('change', ()=>{ t.done = chk.checked; saveTodos(); });
        const main = document.createElement('div'); main.style.flex='1';
        const title = document.createElement('div'); title.textContent = t.text; title.style.fontWeight = '600';
        const meta = document.createElement('div'); meta.className = 'meta';
        const parts = [];
        if(t.priority) parts.push(`<span class="tag">${t.priority}</span>`);
        if(t.due) parts.push(`<span class="muted">${t.due}</span>`);
        if(t.tags && t.tags.length) parts.push(`<span class="muted">${t.tags.join(', ')}</span>`);
        meta.innerHTML = parts.join(' ');
        main.appendChild(title); main.appendChild(meta);

        const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='.4rem';
        const edit = document.createElement('button'); edit.className = 'btn'; edit.textContent = '✎'; edit.title='Редактировать'; edit.addEventListener('click', ()=> editTodo(t.id));
        const del = document.createElement('button'); del.className = 'btn'; del.textContent = '✕'; del.title='Удалить'; del.addEventListener('click', ()=> { todos = todos.filter(x => x.id !== t.id); saveTodos(); });
        btns.appendChild(edit); btns.appendChild(del);

        li.appendChild(chk); li.appendChild(main); li.appendChild(btns);
        ul.appendChild(li);
      });
    }

    function addTodoFromInput(){
      const input = document.getElementById('todoInput');
      const text = (input.value || '').trim();
      if(!text) return;
      const priority = document.getElementById('todoPriority').value || 'normal';
      const due = document.getElementById('todoDue').value || '';
      const newTodo = { id: uid(), text, priority, due: due || '', done: false, tags: [], ts: Date.now() };
      todos.unshift(newTodo);
      input.value = '';
      document.getElementById('todoDue').value = '';
      saveTodos();
    }

    function editTodo(id){
      const t = todos.find(x=>x.id===id);
      if(!t) return;
      openModal(`
        <div style="max-width:640px;background:var(--card-bg);padding:12px;border-radius:8px">
          <h3>Редактировать задачу</h3>
          <div style="display:grid;gap:.5rem">
            <input id="edt_text" value="${escapeHtml(t.text)}" />
            <select id="edt_prio">
              <option value="high">High</option>
              <option value="normal">Normal</option>
              <option value="low">Low</option>
            </select>
            <input id="edt_due" type="date" value="${t.due || ''}" />
            <input id="edt_tags" placeholder="теги через запятую" value="${(t.tags||[]).join(', ')}" />
            <div style="display:flex;gap:.5rem;justify-content:flex-end">
              <button id="edt_cancel" class="btn">Отмена</button>
              <button id="edt_save" class="btn primary">Сохранить</button>
            </div>
          </div>
        </div>
      `);
      document.getElementById('edt_prio').value = t.priority || 'normal';
      document.getElementById('edt_cancel').addEventListener('click', closeModal);
      document.getElementById('edt_save').addEventListener('click', ()=>{
        t.text = document.getElementById('edt_text').value.trim() || t.text;
        t.priority = document.getElementById('edt_prio').value;
        t.due = document.getElementById('edt_due').value || '';
        t.tags = (document.getElementById('edt_tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
        saveTodos();
        closeModal();
      });
    }

    // Export/Import
    document.getElementById('exportTodos').addEventListener('click', ()=>{
      const data = JSON.stringify(todos, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ryazhenka-todos.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('importTodosBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try{
          const data = JSON.parse(ev.target.result);
          if(Array.isArray(data)) {
            // merge safely by id
            const existingIds = new Set(todos.map(t=>t.id));
            data.forEach(it => { if(!it.id) it.id = uid(); if(!existingIds.has(it.id)) todos.push(it); });
            saveTodos();
            alert('Импорт завершён');
          } else alert('Неверный формат');
        }catch(err){ alert('Ошибка импорта'); }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    document.getElementById('todoAdd').addEventListener('click', addTodoFromInput);
    document.getElementById('todoFilter').addEventListener('input', renderTodos);
    document.getElementById('todoSort').addEventListener('change', renderTodos);
    document.getElementById('clearCompleted').addEventListener('click', ()=> { todos = todos.filter(t=>!t.done); saveTodos(); });
    document.getElementById('clearAll').addEventListener('click', ()=> { if(confirm('Удалить все задачи?')) { todos = []; saveTodos(); }});
    document.getElementById('bulkComplete').addEventListener('click', ()=> { todos.forEach(t=>t.done = true); saveTodos(); });

    // ----- Helpers -----
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // ----- Init -----
    document.getElementById('refreshAll').addEventListener('click', ()=> { loadReleases(); refreshCrewFromStorage(); loadTodos(); });
    window.addEventListener('load', ()=> {
      // merge manual crew from storage
      const stored = JSON.parse(localStorage.getItem('rz_manual_crew') || '[]');
      if(stored.length) {
        // prepend stored entries to UI via refresh function
        refreshCrewFromStorage();
      } else {
        loadCrew();
      }
      loadReleases();
      loadTodos();
    });
  </script>
</body>
</html>
