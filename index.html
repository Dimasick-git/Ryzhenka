<!doctype html>
<html lang="ru" data-theme="glow" data-bg="dark" data-text="default">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ryazhenka — generative-styled CFW</title>
  <meta name="description" content="Ryazhenka — стабильная кастомная прошивка. Релизы, модули команды, галерея, благодарности, темы и To‑Do. Всё в одном index.html" />
  <style>
    /* (CSS same as previous versions; omitted here for brevity in display but must remain in the file) */
    /* =========================
       THEME + PALETTE + GLOBAL
       ========================= */
    :root{--radius:14px;--maxw:1200px;--anim-fast:160ms;--anim-medium:320ms;--bg:#05060a;--text-color:#e7eef6;--panel:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));--card:rgba(255,255,255,0.03);--muted:#9aa0a6;--accent:#7c5cff;--accent-2:#39d6ff;--accent-3:#ff9f7a;--glass:rgba(255,255,255,0.04);--card-border:rgba(255,255,255,0.02);}
    /* ... all theme CSS blocks (glow, cyber, aurora, aquamarine etc.) kept unchanged ... */
    /* For full file use the previously provided CSS block — it's unchanged except comments here. */
    .repo-name-gradient{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:800; padding:4px 8px; border-radius:6px; display:inline-block; }
    *{box-sizing:border-box} body{ margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased; color:var(--text-color); background:var(--bg); transition: background 420ms ease, color 320ms ease; }
    /* ... rest of CSS kept unchanged (same as prior full file) ... */
  </style>
</head>

<body>
  <div class="container">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="top-inner">
        <div class="brand" onclick="location.href='./'">
          <img class="logo" src="./assets/Ryazhalogo.png" alt="Ryazhenka" />
          <div>
            <div class="brand-title">Ryazhenka</div>
            <div class="brand-sub">CFW — generative aesthetic</div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <label class="muted" for="themePicker">Тема</label>
          <select id="themePicker" class="small" title="Theme">
            <option value="glow">Glow</option><option value="cyber">Cyber</option><option value="matrix">Matrix</option>
            <option value="classic">Classic</option><option value="sunset">Sunset</option><option value="aurora">Aurora</option>
            <option value="nebula">Nebula</option><option value="sunrise">Sunrise</option><option value="violet">Violet</option>
            <option value="emerald">Emerald</option><option value="aquamarine">Aquamarine</option>
          </select>

          <label class="muted" for="bgMode">Фон</label>
          <select id="bgMode" class="small" title="Background"><option value="dark">Тёмный</option><option value="light">Светлый</option></select>

          <label class="muted" for="textMode">Текст</label>
          <select id="textMode" class="small" title="Text color"><option value="default">Default</option><option value="alt">Alt</option><option value="high">High contrast</option></select>

          <a class="btn ghost" href="https://www.youtube.com/@Dimaick-git" target="_blank">YouTube</a>
          <a class="btn ghost" href="https://t.me/Ryazhenkabestcfw" target="_blank">Telegram</a>
          <a class="btn ghost" href="https://boosty.to/dimasick-git/donate" target="_blank">Boosty</a>
          <a class="btn ghost" href="https://github.com/Dimasick-git/Ryzhenka/wiki" target="_blank">Wiki</a>
        </div>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero glass panel" aria-labelledby="hero-title">
      <div>
        <h1 id="hero-title" class="huge">Ryazhenka</h1>
        <p class="lead">Стабильная кастомная прошивка для Nintendo Switch — красиво, безопасно, удобно. Всё в одном месте: релизы, галерея, благодарности, модули, To‑Do.</p>

        <div class="hero-image" id="heroImageWrap">
          <img id="heroImage" src="./assets/hero.png" alt="Hero preview (from repository if available)" onerror="this.style.display='none'" />
        </div>

        <div class="hero-cta">
          <a class="btn primary" href="#changelog">Релизы</a>
          <a class="btn" href="#gallery">Галерея</a>
          <a class="btn" href="#crew">Благодарности</a>
          <a class="btn" href="#modules">Модули</a>
          <a class="btn" href="#todo">To‑Do</a>
        </div>
      </div>

      <aside>
        <div class="panel quick-stats">
          <div class="stat"><div class="muted">Релизов</div><div id="releasesCount" class="stat-value">—</div></div>
          <div class="stat"><div class="muted">Загрузок</div><div id="downloadsCount" class="stat-value">—</div></div>

          <div class="widgets" id="widgetsArea" aria-hidden="false"></div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="refreshAll" class="btn small">Обновить</button>
            <label style="display:flex;align-items:center;gap:6px"><input id="includeStratosphere" type="checkbox" /> switchbrew/stratosphere</label>
          </div>
        </div>

        <div id="crewMini" class="panel" style="margin-top:12px"></div>
      </aside>
    </section>

    <!-- RELEASES -->
    <section id="changelog" class="panel section" aria-labelledby="releases-title">
      <div class="section-head">
        <h2 id="releases-title">История изменений / Релизы</h2>
        <div class="searchbar">
          <input id="searchReleases" type="text" placeholder="Поиск (версия, название, описание)" list="releases-suggestions" />
          <datalist id="releases-suggestions"></datalist>
          <select id="filterType"><option value="all">Все типы</option><option value="Ryazhenkabestcfw">BestCFW</option><option value="Ryazhenka_AIO">AIO</option><option value="Ryazhenka_lite">Lite</option></select>
          <select id="sortBy"><option value="date_desc">По дате ↓</option><option value="date_asc">По дате ↑</option><option value="downloads_desc">По загрузкам ↓</option></select>
        </div>
      </div>

      <div id="releasesGrouped"></div>
    </section>

    <!-- MODULES -->
    <section id="modules" class="panel section">
      <div class="section-head">
        <h2 id="modules-title">Модули команды</h2>
        <div class="modules-config">
          <input id="moduleRepoInput" placeholder="owner/repo (например Dimasick-git/Ryazhahand-Overlay)" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)" />
          <button id="addModuleBtn" class="btn">Добавить репозиторий</button>
          <button id="refreshModules" class="btn small">Обновить</button>
        </div>
      </div>

      <div id="moduleList" class="module-list"></div>
      <div id="modulesGrouped"></div>
      <small class="muted">Добавьте репозитории модулей вашей команды (owner/repo). Скрипт подтянет релизы и превью (ищет и в релиз-ассетах, и в common paths репо).</small>
    </section>

    <!-- GALLERY -->
    <section id="gallery" class="panel section">
      <h2>Галерея</h2>
      <div id="galleryGrid" class="gallery-grid"></div>
    </section>

    <!-- CREW -->
    <section id="crew" class="panel section">
      <div class="section-head">
        <h2>Благодарности / Стена экипажа</h2>
        <div style="display:flex;gap:8px">
          <button id="addCrewBtn" class="btn small">Добавить</button>
          <button id="exportCrewBtn" class="btn small">Экспорт</button>
          <button id="importCrewBtn" class="btn small">Импорт</button>
          <input id="importCrewFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
      <div id="crewGrid" class="crew-grid"></div>
    </section>

    <!-- TODO -->
    <section id="todo" class="panel section">
      <h2>To‑Do (локально)</h2>
      <div class="todo-layout">
        <div>
          <div class="todo-add">
            <input id="todoInput" placeholder="Название задачи" />
            <select id="todoPriority"><option value="normal">Normal</option><option value="high">High</option><option value="low">Low</option></select>
            <input id="todoDue" type="date" />
            <button id="todoAdd" class="btn primary">Добавить</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <input id="todoFilter" placeholder="Фильтр..." style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text-color)" />
            <select id="todoSort"><option value="new">Новые</option><option value="old">Старые</option><option value="prio">По приоритету</option><option value="due">По дате</option></select>
            <button id="exportTodos" class="btn">Экспорт</button>
            <input id="todoImportFile" type="file" accept="application/json" style="display:none" />
            <button id="importTodosBtn" class="btn">Импорт</button>
          </div>

          <ul id="todoList" class="todo-list" aria-live="polite" style="margin-top:12px"></ul>
        </div>

        <aside style="padding-left:12px;border-left:1px solid var(--card-border)">
          <button id="clearCompleted" class="btn small">Удалить выполненные</button>
          <button id="clearAll" class="btn small">Удалить все</button>
          <button id="bulkComplete" class="btn small">Отметить все</button>
          <div class="muted" style="margin-top:12px">Задачи сохраняются в localStorage.</div>
        </aside>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="muted">© Ryazhenka — crew.ecosystem</div>
        <div class="muted">Design: Midjourney‑like • Client‑side • Boosty: <a href="https://boosty.to/dimasick-git/donate" target="_blank">boosty.to/dimasick-git/donate</a></div>
      </div>
    </footer>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true"></div>

  <script>
    (function(){
      // CONFIG
      const mainRepoFull = 'Dimasick-git/Ryzhenka';
      const baseRepos = [mainRepoFull,'Atmosphere-NX/Atmosphere','CTCaer/hekate'];
      const limitedRepos = new Set(['Atmosphere-NX/Atmosphere','CTCaer/hekate']);
      const optionalRepo = 'switchbrew/stratosphere';
      const releasesPerRepo = 100;
      const cacheKey = 'rz_cache_v8';
      const cacheTTL = 1000 * 60 * 5;
      const crewKey = 'rz_manual_crew_v8';
      const todoKey = 'rz_todos_v8';
      const settingsKey = 'rz_ui_settings_v8';
      const commentsKey = 'rz_comments_v1';
      const moduleReposKey = 'rz_module_repos_v1';
      const modulesCacheKey = 'rz_modules_cache_v1';
      const repoImageCacheKey = 'rz_repo_image_cache_v1';
      const repoImageCacheTTL = 1000 * 60 * 60 * 6; // 6 hours

      // DOM
      const releasesGroupedEl = document.getElementById('releasesGrouped');
      const galleryGridEl = document.getElementById('galleryGrid');
      const crewGridEl = document.getElementById('crewGrid');
      const crewMiniEl = document.getElementById('crewMini');
      const releasesCountEl = document.getElementById('releasesCount');
      const downloadsCountEl = document.getElementById('downloadsCount');
      const widgetsArea = document.getElementById('widgetsArea');

      const searchReleases = document.getElementById('searchReleases');
      const suggestions = document.getElementById('releases-suggestions');
      const filterType = document.getElementById('filterType');
      const sortBy = document.getElementById('sortBy');
      const includeStrato = document.getElementById('includeStratosphere');

      const themePicker = document.getElementById('themePicker');
      const bgMode = document.getElementById('bgMode');
      const textMode = document.getElementById('textMode');

      const addCrewBtn = document.getElementById('addCrewBtn');
      const exportCrewBtn = document.getElementById('exportCrewBtn');
      const importCrewBtn = document.getElementById('importCrewBtn');
      const importCrewFile = document.getElementById('importCrewFile');

      const todoInput = document.getElementById('todoInput');
      const todoPriority = document.getElementById('todoPriority');
      const todoDue = document.getElementById('todoDue');
      const todoAdd = document.getElementById('todoAdd');
      const todoListEl = document.getElementById('todoList');
      const todoFilter = document.getElementById('todoFilter');
      const todoSort = document.getElementById('todoSort');
      const exportTodosBtn = document.getElementById('exportTodos');
      const importTodosBtn = document.getElementById('importTodosBtn');
      const todoImportFile = document.getElementById('todoImportFile');
      const clearCompletedBtn = document.getElementById('clearCompleted');
      const clearAllBtn = document.getElementById('clearAll');
      const bulkCompleteBtn = document.getElementById('bulkComplete');

      const refreshAllBtn = document.getElementById('refreshAll');

      // Modules UI
      const moduleRepoInput = document.getElementById('moduleRepoInput');
      const addModuleBtn = document.getElementById('addModuleBtn');
      const moduleListEl = document.getElementById('moduleList');
      const modulesGroupedEl = document.getElementById('modulesGrouped');
      const refreshModulesBtn = document.getElementById('refreshModules');

      // defaults
      const defaultManualCrew = [
        { login: 'Dimasick-git', name: 'Dimasick-git', role: 'Основатель' },
        { login: 'Ryazhenka-Helper-1', name: 'Ryazhenka-Helper-1', role: 'Модульный разработчик (sys-clk)' },
        { login: 'Ryazhenka-Helper-01', name: 'Ryazhenka-Helper-01', role: 'Видео / тестирование / YouTube' }
      ];
      const defaultModuleRepos = [
        'Dimasick-git/Ryazhahand-Overlay',
        'Dimasick-git/libRYAZHAHAND',
        'Ryazhenka-Helper-1/Sys-clk-for-RYZ'
      ];

      // OVERRIDES: explicit image URLs you provided — these get top priority
      const overrideImages = {
        'CTCaer/hekate': 'https://user-images.githubusercontent.com/3665130/60391760-bc1e8c00-9afe-11e9-8b7a-b065873081b2.png',
        'Atmosphere-NX/Atmosphere': 'https://raw.githubusercontent.com/Atmosphere-NX/Atmosphere/refs/heads/master/img/banner.png',
        'Dimasick-git/Ryazhahand-Overlay': 'https://raw.githubusercontent.com/Dimasick-git/Ryazhahand-Overlay/main/.pics/Ryazhahand.png',
        'Dimasick-git/libRYAZHAHAND': 'https://raw.githubusercontent.com/Dimasick-git/libRYAZHAHAND/main/.pics/libRyazhahand.png'
      };

      // small helpers
      function el(tag, attrs={}, ...children){
        const e = document.createElement(tag);
        for(const k in attrs){
          if(k==='class') e.className = attrs[k];
          else if(k==='html') e.innerHTML = attrs[k];
          else e.setAttribute(k, attrs[k]);
        }
        children.forEach(c => { if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
        return e;
      }
      function fmtDate(iso){ if(!iso) return ''; try{return new Date(iso).toLocaleDateString();}catch(e){return iso;} }
      function bbootLogoUrl(repoFull, tag){ return `https://github.com/${repoFull}/releases/download/${encodeURIComponent(tag)}/bbootlogo.png`; }
      function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

      // settings
      function applyTextOverrides(textModeValue, bgValue){
        const root = document.documentElement;
        root.style.removeProperty('--text-color'); root.style.removeProperty('--muted');
        if(textModeValue === 'alt'){ if(bgValue === 'light'){ root.style.setProperty('--text-color','#2b2b2b'); root.style.setProperty('--muted','#6b5b4a'); } else { root.style.setProperty('--text-color','#f3e8d8'); root.style.setProperty('--muted','#cdbfa6'); } }
        else if(textModeValue === 'high'){ if(bgValue === 'light'){ root.style.setProperty('--text-color','#0b0b0b'); root.style.setProperty('--muted','#444444'); } else { root.style.setProperty('--text-color','#ffffff'); root.style.setProperty('--muted','#bfc9d6'); } }
      }
      function loadSettings(){
        try{
          const s = JSON.parse(localStorage.getItem(settingsKey) || '{}');
          const theme = s.theme || 'glow'; const bg = s.bg || 'dark'; const text = s.text || 'default';
          document.documentElement.dataset.theme = theme; document.documentElement.dataset.bg = bg; document.documentElement.dataset.text = text;
          if(themePicker) themePicker.value = theme; if(bgMode) bgMode.value = bg; if(textMode) textMode.value = text;
          applyTextOverrides(text,bg);
        }catch(e){}
      }
      function saveSettings(){ const s = { theme: themePicker.value, bg: bgMode.value, text: textMode.value }; localStorage.setItem(settingsKey, JSON.stringify(s)); loadSettings(); }
      themePicker && themePicker.addEventListener('change', saveSettings); bgMode && bgMode.addEventListener('change', saveSettings); textMode && textMode.addEventListener('change', saveSettings);
      loadSettings();

      // HERO image loader (unchanged)
      (function tryLoadHeroFromRepo(){
        const img = document.getElementById('heroImage'); if(!img) return;
        const repoRawBase = 'https://raw.githubusercontent.com/Dimasick-git/Ryzhenka/main';
        const candidatePaths = ['/assets/hero.png','/assets/hero.webp','/assets/hero.jpg','/assets/preview.png','/assets/Ryazhalogo.png'];
        (async ()=>{
          for(const p of candidatePaths){
            const url = repoRawBase + p;
            try{
              let ok=false;
              try{ const r = await fetch(url,{method:'HEAD'}); ok = r.ok && r.status !== 404; } catch(e){ try{ const r2 = await fetch(url,{method:'GET'}); ok = r2.ok && r2.status !== 404; }catch(e2){ ok=false; } }
              if(ok){ img.src = url; img.style.display=''; return; }
            }catch(e){}
          }
          const test = new Image(); test.onload = ()=>{}; test.onerror = ()=>{ img.style.display='none' }; test.src = img.src;
        })();
      })();

      // Find repo image: check overrides first, then branches main/master, common paths, with caching
      async function findRepoImage(repoFull){
        try{
          // 1) explicit override map (top priority)
          if(overrideImages[repoFull]) return overrideImages[repoFull];

          // 2) cache check
          let cache = {};
          try{ cache = JSON.parse(localStorage.getItem(repoImageCacheKey) || '{}'); }catch(e){ cache = {}; }
          if(cache[repoFull] && (Date.now() - cache[repoFull].ts < repoImageCacheTTL)) return cache[repoFull].url;

          // 3) common branch candidates
          const branches = ['main','master','develop'];
          const candidates = [
            '/.pics/preview.png','/.pics/preview.webp','/.pics/Ryazhahand.png','/.pics/libRyazhahand.png',
            '/assets/preview.png','/assets/preview.webp','/assets/hero.png','/assets/hero.webp','/assets/hero.jpg',
            '/assets/screenshot.png','/assets/screenshot.webp','/assets/banner.png','/assets/logo.png',
            '/screenshot.png','/screenshot.webp','/preview.png','/preview.webp','/banner.png','/logo.png',
            '/images/preview.png','/images/screenshot.png','/docs/preview.png'
          ];

          for(const br of branches){
            const base = `https://raw.githubusercontent.com/${repoFull}/${br}`;
            for(const p of candidates){
              const url = base + p;
              try{
                let ok = false;
                try{ const res = await fetch(url, { method:'HEAD' }); ok = res.ok && res.status !== 404; }
                catch(e){
                  try{ const r2 = await fetch(url, { method:'GET' }); ok = r2.ok && r2.status !== 404; } catch(e2){ ok = false; }
                }
                if(ok){
                  cache[repoFull] = { url, ts: Date.now() };
                  try{ localStorage.setItem(repoImageCacheKey, JSON.stringify(cache)); }catch(e){}
                  return url;
                }
              }catch(e){}
            }
          }
        }catch(e){}
        return null;
      }

      // Fetch releases for a repo
      async function fetchReleasesFromRepo(repoFull){
        const url = `https://api.github.com/repos/${repoFull}/releases?per_page=${releasesPerRepo}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Failed ${repoFull}: ${res.status}`);
        const data = await res.json();
        return (Array.isArray(data) ? data : []).map(r => ({...r, _repo: repoFull}));
      }

      function getRepoList(){ const list = baseRepos.slice(); if(includeStrato && includeStrato.checked) list.push(optionalRepo); return list; }

      // Load releases, enforce limitedRepos to keep only latest 3 for those repos
      async function loadReleases(){
        try{
          const raw = localStorage.getItem(cacheKey);
          if(raw){
            const parsed = JSON.parse(raw);
            if(Date.now() - parsed.ts < cacheTTL && Array.isArray(parsed.data)){
              window.__rz_releases = parsed.data;
              buildSuggestions(); renderReleasesGrouped(); renderGallery(); computeStats(); renderWidgets();
              return;
            }
          }
        }catch(e){}
        const repos = getRepoList();
        releasesGroupedEl.innerHTML=''; galleryGridEl.innerHTML=''; releasesCountEl.textContent='…'; downloadsCountEl.textContent='…';
        const jobs = repos.map(r => fetchReleasesFromRepo(r).catch(err => { console.warn(err); return []; }));
        const results = await Promise.all(jobs);
        const combined = results.flat();

        // dedupe by repo+tag
        const map = new Map();
        combined.forEach(r => {
          const key = `${r._repo}::${r.tag_name || r.name || ''}`;
          if(!map.has(key)) map.set(key, r);
        });
        // group by repo, enforce limitedRepos limit
        const byRepo = {};
        Array.from(map.values()).sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at)).forEach(r => {
          (byRepo[r._repo] = byRepo[r._repo] || []).push(r);
        });
        // assemble final array where limited repos have only top 3
        const finalArr = [];
        Object.keys(byRepo).forEach(repo => {
          const items = byRepo[repo];
          if(limitedRepos.has(repo)){
            finalArr.push(...items.slice(0,3));
          } else {
            finalArr.push(...items);
          }
        });

        try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: finalArr })); }catch(e){}
        window.__rz_releases = finalArr;
        buildSuggestions(); renderReleasesGrouped(); renderGallery(); computeStats(); renderWidgets();
      }

      function buildSuggestions(){
        if(!suggestions) return;
        suggestions.innerHTML = '';
        const data = window.__rz_releases || [];
        const seen = new Set();
        data.slice(0,150).forEach(r => {
          const text = (r.tag_name || r.name || '').slice(0,120);
          if(text && !seen.has(text)){ const opt = document.createElement('option'); opt.value = text; suggestions.appendChild(opt); seen.add(text); }
        });
      }

      // makeReleaseCard: set placeholder and try to replace with repo image if no asset image, using overrideImages first
      function makeReleaseCard(r){
        const ver = r.tag_name || r.name || '';
        const assets = r.assets || [];
        const assetImage = assets.find(a => /\.(gif|webp|png|jpe?g)$/i.test(a.name || ''));
        // priority: overrideImages -> assetImage -> repo image (async) -> bboot logo
        const override = overrideImages[r._repo];
        const previewPlaceholder = override || (assetImage ? assetImage.browser_download_url : bbootLogoUrl(r._repo || mainRepoFull, ver));

        const img = el('img', { src: previewPlaceholder, alt: ver });
        img.style.width='100%'; img.style.height='140px'; img.style.objectFit='cover'; img.style.borderRadius='8px';

        // if assetImage absent and no override, async try to find repo image and replace when found
        if(!assetImage && !override){
          (async () => {
            try{
              const found = await findRepoImage(r._repo || mainRepoFull);
              if(found) {
                // replace the src if still placeholder (avoid overriding if another image replaced it)
                if(img && img.src && (img.src.indexOf('bbootlogo') !== -1 || img.src.indexOf('raw.githubusercontent.com') === -1)) {
                  img.src = found;
                } else {
                  img.src = found;
                }
              }
            }catch(e){ /* ignore */ }
          })();
        }

        const repoBadge = el('div', { class: 'repo-badge' }, r._repo || '');
        const h3 = el('h3', {}, r.name || ver);
        const meta = el('div', { class: 'meta' }, el('span', {}, fmtDate(r.published_at || r.created_at)), el('span', {}, ver));
        const p = r.body ? el('p', {}, r.body.length > 240 ? r.body.slice(0,240) + '…' : r.body) : null;
        const card = el('article', { class: 'release-card' }, repoBadge, img, h3, meta);
        if(p) card.appendChild(p);

        if((assets || []).length > 0){
          const assetsWrap = el('div', { style: 'display:flex;flex-direction:column;gap:6px;margin-top:8px' });
          const titles = ['Ryazhenkabestcfw','Ryazhenka_AIO','Ryazhenka_lite'];
          titles.forEach(t => {
            const asset = assets.find(a => a.name && a.name.toLowerCase().includes(t.toLowerCase()));
            const row = el('div', { style: 'display:flex;align-items:center;gap:8px' });
            if(asset){
              const ael = el('a', { href: asset.browser_download_url, target: '_blank', class:'btn small' }, `${t} — ${asset.name}`);
              row.appendChild(ael);
              const size = el('small', { style: 'margin-left:auto;color:var(--muted)' }, asset.size ? `${(asset.size/1024/1024).toFixed(2)} MB` : '');
              row.appendChild(size);
            } else {
              row.appendChild(el('small', { style: 'color:var(--muted)' }, `${t} — отсутствует`));
            }
            assetsWrap.appendChild(row);
          });
          card.appendChild(assetsWrap);
        }

        img.addEventListener('click', () => {
          openModal(`<div class="inner"><img src="${img.src}" style="width:100%;height:auto;border-radius:8px" /><div style="margin-top:10px"><strong>${escapeHtml(r.name || ver)}</strong><div class="muted">${fmtDate(r.published_at || r.created_at)} • ${escapeHtml(r._repo || '')}</div><div style="margin-top:8px">${r.body ? escapeHtml(r.body).slice(0,1200) : ''}</div></div></div>`);
        });

        if(r.html_url){
          const link = el('a', { class: 'btn', href: r.html_url, target: '_blank', style: 'margin-top:8px' }, 'Открыть релиз');
          card.appendChild(link);
        }
        return card;
      }

      function renderReleasesGrouped(){
        const all = window.__rz_releases || [];
        const q = (searchReleases || {}).value || '';
        const type = (filterType || {}).value || 'all';
        const sort = (sortBy || {}).value || 'date_desc';

        const filtered = all.filter(r => {
          const ver = (r.tag_name || r.name || '').toLowerCase();
          const title = (r.name || '').toLowerCase();
          const body = (r.body || '').toLowerCase();
          const repo = (r._repo || '').toLowerCase();
          const combined = [ver,title,body,repo].join(' ');
          const qOk = !q || combined.includes(q.toLowerCase());
          let tOk = true;
          if(type && type !== 'all') tOk = (r.assets || []).some(a => a.name && a.name.toLowerCase().includes(type.toLowerCase()));
          return qOk && tOk;
        });

        const groups = {};
        filtered.forEach(r => { const repo = r._repo || mainRepoFull; (groups[repo] = groups[repo] || []).push(r); });

        const orderedRepos = [];
        const mainKey = mainRepoFull;
        if(groups[mainKey]) orderedRepos.push(mainKey);
        Object.keys(groups).forEach(k => { if(k !== mainKey) orderedRepos.push(k); });

        releasesGroupedEl.innerHTML = '';
        let totalCount = 0;
        orderedRepos.forEach(repoFull => {
          let items = groups[repoFull] || [];
          if(items.length === 0) return;
          if(sort === 'date_desc') items.sort((a,b) => new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at));
          if(sort === 'date_asc') items.sort((a,b) => new Date(a.published_at || a.created_at) - new Date(b.published_at || b.created_at));
          if(sort === 'downloads_desc') items.sort((a,b) => ((b.assets||[]).reduce((s,x)=>s+(x.download_count||0),0)) - ((a.assets||[]).reduce((s,x)=>s+(x.download_count||0),0)));

          if(limitedRepos.has(repoFull)) items = items.slice(0,3);

          const header = el('div', { class: 'releases-by-repo' },
            el('div', { class:'repo-title' },
              el('a', { href: `https://github.com/${repoFull}`, target:'_blank', class:'repo-name repo-name-gradient', title: `Открыть ${repoFull}` }, repoFull),
              el('div', { style:'margin-left:8px;color:var(--muted)' }, `${items.length} релизов`)
            ),
            el('div', { class:'releases-grid' })
          );
          const grid = header.querySelector('.releases-grid');
          items.forEach(r => grid.appendChild(makeReleaseCard(r)));
          releasesGroupedEl.appendChild(header);
          totalCount += items.length;
        });
        releasesCountEl.textContent = totalCount;
      }

      function renderGallery(){
        galleryGridEl.innerHTML = '';
        (window.__rz_releases || []).forEach(r => {
          const assets = r.assets || [];
          const chosen = assets.find(a => /\.(gif|webp|png|jpe?g)$/i.test(a.name || '')) || assets[0];
          const src = chosen ? chosen.browser_download_url : (overrideImages[r._repo] || bbootLogoUrl(r._repo || mainRepoFull, r.tag_name || r.name || ''));
          const img = el('img', { src, alt: r.tag_name || r.name || '' });
          img.addEventListener('click', () => openModal(`<div class="inner"><img src="${src}" style="width:100%;height:auto;border-radius:8px" /><div style="margin-top:10px"><strong>${escapeHtml(r.name || r.tag_name)}</strong><div class="muted">${fmtDate(r.published_at || r.created_at)} • ${escapeHtml(r._repo || '')}</div></div></div>`));
          galleryGridEl.appendChild(img);
        });
      }

      function computeStats(){
        const data = window.__rz_releases || [];
        let total = 0;
        data.forEach(r => (r.assets||[]).forEach(a => { if(typeof a.download_count === 'number') total += a.download_count; }));
        downloadsCountEl.textContent = total;
      }

      // Widgets: top priority overrideImages -> release asset -> findRepoImage -> bboot
      async function renderWidgets(){
        widgetsArea.innerHTML = '';
        const data = window.__rz_releases || [];
        if(!data.length) return;
        const widgetRepos = [mainRepoFull,'Atmosphere-NX/Atmosphere','CTCaer/hekate'];
        try{ const modules = JSON.parse(localStorage.getItem(moduleReposKey) || '[]'); if(Array.isArray(modules)) widgetRepos.push(...modules.slice(0,3)); }catch(e){}
        const seen = new Set();
        for(const repo of widgetRepos){
          const repoItems = data.filter(r => (r._repo||'') === repo).sort((a,b)=> new Date(b.published_at||b.created_at)-new Date(a.published_at||a.created_at));
          if(!repoItems.length) continue;
          const latest = repoItems[0];
          if(seen.has(repo)) continue;
          seen.add(repo);
          let imgSrc = '';
          // 1) override
          if(overrideImages[repo]) imgSrc = overrideImages[repo];
          // 2) release asset
          else {
            const assetImg = (latest.assets||[]).find(a=>/\.(gif|webp|png|jpe?g)$/i.test(a.name||'')) || (latest.assets||[])[0];
            if(assetImg) imgSrc = assetImg.browser_download_url;
            else {
              const found = await findRepoImage(repo);
              imgSrc = found || bbootLogoUrl(latest._repo, latest.tag_name || latest.name);
            }
          }

          const widget = el('div',{class:'widget'},
            el('img',{src:imgSrc,alt: latest.tag_name || latest.name}),
            el('div',{},
              el('div',{style:'font-weight:700'}, el('a',{href:`https://github.com/${repo}`, target:'_blank', style:'color:inherit;text-decoration:none'}, repo)),
              el('div',{class:'muted',style:'font-size:.9rem'}, `${latest.tag_name || latest.name} • ${fmtDate(latest.published_at || latest.created_at)}`),
              el('div',{style:'margin-top:6px'}, el('a',{class:'btn small', href: latest.html_url, target:'_blank'}, 'Открыть релиз'))
            )
          );
          widgetsArea.appendChild(widget);
        }
      }

      // Crew and modules logic (unchanged except modules defaults)
      function getManualCrew(){ try{ return JSON.parse(localStorage.getItem(crewKey) || '[]'); }catch(e){ return []; } }
      function saveManualCrew(arr){ localStorage.setItem(crewKey, JSON.stringify(arr)); }

      function makeCrewCard(p){
        const avatar = p.avatar || `https://github.com/${p.login}.png`;
        const img = el('img',{src:avatar,alt:p.login}); img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='10px';
        const nameLink = el('a',{href:`https://github.com/${p.login}`,target:'_blank'}, p.login); nameLink.style.fontWeight='700';
        const name = el('div',{}, nameLink);
        if(p.name && p.name !== p.login) name.appendChild(document.createTextNode(' — ' + p.name));
        const role = p.role ? el('div',{class:'muted'},p.role) : null;
        const contrib = el('div',{class:'muted'}, `Commits: ${p.contributions || 0}`);
        const info = el('div',{}, name, role || '', contrib);
        const card = el('div',{class:'crew-card', title:'Клик для деталей'}, img, info);
        card.addEventListener('click', ()=>{
          const kudosKey = `kudos_${p.login.toLowerCase()}`; const current = parseInt(localStorage.getItem(kudosKey) || '0', 10);
          openModal(`<div class="inner"><div style="display:flex;gap:12px;align-items:center"><img src="${avatar}" style="width:96px;height:96px;border-radius:12px"/><div><h3>${escapeHtml(p.name || p.login)}</h3><div class="muted">${escapeHtml(p.role || '')}</div><div style="margin-top:8px"><small class="muted">Коммитов: ${p.contributions || 0}</small></div><div class="crew-actions" style="margin-top:12px"><a class="btn" href="https://github.com/${p.login}" target="_blank">Открыть GitHub</a><button id="giveKudos" class="btn primary">+1 Kudos</button><button id="closeCrewModal" class="btn">Закрыть</button></div><div id="kudosCount" style="margin-top:8px" class="muted">Kudos: ${current}</div></div></div></div>`);
          document.getElementById('giveKudos').addEventListener('click', () => { const key = `kudos_${p.login.toLowerCase()}`; const cur = parseInt(localStorage.getItem(key) || '0',10)+1; localStorage.setItem(key,String(cur)); const elK = document.getElementById('kudosCount'); if(elK) elK.textContent = 'Kudos: ' + cur; });
          document.getElementById('closeCrewModal').addEventListener('click', closeModal);
        });
        return card;
      }

      async function loadCrew(){
        crewGridEl.innerHTML = ''; crewMiniEl.innerHTML = '';
        const stored = getManualCrew();
        const merged = (stored || []).concat(defaultManualCrew);
        merged.slice(0,6).forEach(m => crewMiniEl.appendChild(makeCrewCard(m)));
        merged.forEach(m => crewGridEl.appendChild(makeCrewCard(m)));
        try{
          const url = `https://api.github.com/repos/${mainRepoFull}/contributors?per_page=100`;
          const res = await fetch(url);
          if(res.ok){
            const list = await res.json();
            const seen = new Set(merged.map(x => x.login.toLowerCase()));
            list.forEach(c => { if(!seen.has(c.login.toLowerCase())) crewGridEl.appendChild(makeCrewCard({ login: c.login, avatar: c.avatar_url, contributions: c.contributions })); });
          }
        }catch(e){ console.warn('contributors failed', e); }
      }

      // Modules management
      function getModuleRepos(){ try{ const raw = localStorage.getItem(moduleReposKey); if(raw) return JSON.parse(raw); }catch(e){} return defaultModuleRepos.slice(); }
      function saveModuleRepos(arr){ localStorage.setItem(moduleReposKey, JSON.stringify(arr)); }
      function renderModuleListUI(){ const arr = getModuleRepos(); moduleListEl.innerHTML = ''; arr.forEach((r,idx)=>{ const removeBtn = el('button',{class:'btn small'}, 'Удалить'); removeBtn.addEventListener('click', ()=>{ removeModuleAt(idx); }); const item = el('div',{class:'module-item'}, el('div',{}, r), removeBtn); moduleListEl.appendChild(item); }); }
      function addModule(repoFull){ if(!repoFull || !repoFull.includes('/')){ alert('Введите репозиторий в формате owner/repo'); return; } const arr = getModuleRepos(); if(arr.includes(repoFull)){ alert('Репозиторий уже добавлен'); return; } arr.unshift(repoFull); saveModuleRepos(arr); renderModuleListUI(); loadModules(); }
      function removeModuleAt(idx){ const arr = getModuleRepos(); if(idx<0||idx>=arr.length) return; arr.splice(idx,1); saveModuleRepos(arr); renderModuleListUI(); loadModules(); }
      addModuleBtn && addModuleBtn.addEventListener('click', ()=>{ const v=(moduleRepoInput||{}).value.trim(); if(!v){ alert('Введите owner/repo'); return; } addModule(v); moduleRepoInput.value=''; });
      refreshModulesBtn && refreshModulesBtn.addEventListener('click', ()=>{ try{ localStorage.removeItem(modulesCacheKey); }catch(e){} loadModules(); });

      async function loadModules(){
        const repos = getModuleRepos();
        try{
          const raw = localStorage.getItem(modulesCacheKey);
          if(raw){ const parsed = JSON.parse(raw); if(Date.now() - parsed.ts < cacheTTL && Array.isArray(parsed.data)){ window.__rz_modules = parsed.data; renderModulesGrouped(); renderWidgets(); return; } }
        }catch(e){}
        const jobs = repos.map(r => fetchReleasesFromRepo(r).catch(err=>{ console.warn('module fetch failed', r, err); return []; }));
        const results = await Promise.all(jobs); const combined = results.flat();
        const map = new Map(); combined.forEach(r => { const key = `${r._repo}::${r.tag_name || r.name || ''}`; if(!map.has(key)) map.set(key, r); });
        const arr = Array.from(map.values()).sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at));
        try{ localStorage.setItem(modulesCacheKey, JSON.stringify({ts:Date.now(),data:arr})); }catch(e){}
        window.__rz_modules = arr; renderModulesGrouped(); renderWidgets();
      }

      function renderModulesGrouped(){
        const all = window.__rz_modules || []; const q = (searchReleases||{}).value||''; const type = (filterType||{}).value||'all'; const sort = (sortBy||{}).value||'date_desc';
        const filtered = all.filter(r => { const ver=(r.tag_name||r.name||'').toLowerCase(); const title=(r.name||'').toLowerCase(); const body=(r.body||'').toLowerCase(); const repo=(r._repo||'').toLowerCase(); const combined=[ver,title,body,repo].join(' '); const qOk = !q || combined.includes(q.toLowerCase()); let tOk=true; if(type && type!=='all') tOk = (r.assets||[]).some(a => a.name && a.name.toLowerCase().includes(type.toLowerCase())); return qOk && tOk; });

        const groups = {}; filtered.forEach(r => { const repo = r._repo || ''; (groups[repo] = groups[repo]||[]).push(r); });

        modulesGroupedEl.innerHTML = '';
        Object.keys(groups).forEach(repoFull => {
          const items = groups[repoFull]; if(!items || items.length===0) return;
          if(sort==='date_desc') items.sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at));
          if(sort==='date_asc') items.sort((a,b)=> new Date(a.published_at||a.created_at) - new Date(b.published_at||b.created_at));
          if(sort==='downloads_desc') items.sort((a,b)=> ((b.assets||[]).reduce((s,x)=>s+(x.download_count||0),0)) - ((a.assets||[]).reduce((s,x)=>s+(x.download_count||0),0)));

          const header = el('div',{class:'releases-by-repo'},
            el('div',{class:'repo-title'},
              el('a',{href:`https://github.com/${repoFull}`, target:'_blank', class:'repo-name repo-name-gradient'}, repoFull),
              el('div',{style:'margin-left:8px;color:var(--muted)'}, `${items.length} релизов`)
            ),
            el('div',{class:'releases-grid'})
          );
          const grid = header.querySelector('.releases-grid');
          items.forEach(r => grid.appendChild(makeReleaseCard(r)));
          modulesGroupedEl.appendChild(header);
        });
      }

      // init
      async function loadAll(){
        loadSettings(); todos = loadTodos(); renderTodos(); await loadReleases(); await loadCrew(); renderModuleListUI(); await loadModules();
        const commentsContainer = document.createElement('div'); commentsContainer.style.marginTop='12px'; commentsContainer.innerHTML = '<strong>Комментарии</strong>'; loadLocalCommentsUI(commentsContainer);
        if(crewMiniEl) crewMiniEl.appendChild(commentsContainer);
      }

      // Expose for debug
      window.RZ = { loadReleases, loadCrew, loadAll, loadModules, addModule, removeModuleAt, findRepoImage };

      // run
      loadAll();

      // --- helper functions moved here to avoid linter errors (loadTodos/renderTodos etc.) ---
      function loadTodos(){ try{ return JSON.parse(localStorage.getItem(todoKey) || '[]'); }catch(e){ return []; } }
      function saveTodos(arr){ localStorage.setItem(todoKey, JSON.stringify(arr)); renderTodos(); }
      function newTodoId(){ return 'td_' + Math.random().toString(36).slice(2,9); }
      let todos = loadTodos();
      function renderTodos(){ /* same as previous implementation */ const filter=(todoFilter||{}).value||''; const sort=(todoSort||{}).value||'new'; todoListEl.innerHTML=''; let list = todos.slice(); if(filter) list = list.filter(t=> (t.text + ' ' + (t.tags||'')).toLowerCase().includes(filter.toLowerCase())); if(sort==='new') list.sort((a,b)=> b.ts - a.ts); if(sort==='old') list.sort((a,b)=> a.ts - b.ts); if(sort==='prio') list.sort((a,b)=> ({high:2,normal:1,low:0}[b.priority] - {high:2,normal:1,low:0}[a.priority])); if(sort==='due') list.sort((a,b)=> (a.due ? new Date(a.due).getTime() : Infinity) - (b.due ? new Date(b.due).getTime() : Infinity)); list.forEach(item=>{ const chk=el('input'); chk.type='checkbox'; chk.checked=!!item.done; chk.addEventListener('change', ()=>{ item.done = chk.checked; saveTodos(todos); }); const title = el('div',{}, el('div',{style:'font-weight:700'}, item.text), el('div',{class:'muted'}, `${item.priority}${item.due ? ' • ' + item.due : ''}`)); const edit = el('button',{class:'btn small'}, '✎'); edit.addEventListener('click', ()=> editTodo(item.id)); const del = el('button',{class:'btn small'}, '✕'); del.addEventListener('click', ()=>{ todos = todos.filter(t=>t.id!==item.id); saveTodos(todos); }); const li = el('li',{class:'todo-item'}, chk, title, el('div',{}, edit, del)); if(item.done) li.classList.add('completed'); todoListEl.appendChild(li); }); }
      todoAdd && todoAdd.addEventListener('click', ()=>{ const text=(todoInput||{}).value||''; if(!text.trim()) return; const priority=(todoPriority||{}).value||'normal'; const due=(todoDue||{}).value||''; const t={id:newTodoId(),text:text.trim(),priority,due,done:false,ts:Date.now()}; todos.unshift(t); (todoInput||{}).value=''; (todoDue||{}).value=''; saveTodos(todos); });
      function editTodo(id){ const t = todos.find(x=>x.id===id); if(!t) return; openModal(`<div class="inner"><h3>Редактировать задачу</h3><div style="display:grid;gap:8px"><input id="edt_text" value="${escapeHtml(t.text)}" /><select id="edt_prio"><option value="high">High</option><option value="normal">Normal</option><option value="low">Low</option></select><input id="edt_due" type="date" value="${t.due || ''}" /><div style="display:flex;gap:8px;justify-content:flex-end"><button id="edt_cancel" class="btn">Отмена</button><button id="edt_save" class="btn primary">Сохранить</button></div></div></div>`); document.getElementById('edt_prio').value = t.priority || 'normal'; document.getElementById('edt_cancel').addEventListener('click', closeModal); document.getElementById('edt_save').addEventListener('click', ()=>{ t.text = (document.getElementById('edt_text')||{}).value.trim() || t.text; t.priority = (document.getElementById('edt_prio')||{}).value || t.priority; t.due = (document.getElementById('edt_due')||{}).value || ''; saveTodos(todos); closeModal(); }); }
      exportTodosBtn && exportTodosBtn.addEventListener('click', ()=>{ const data = JSON.stringify(todos,null,2); const blob = new Blob([data], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ryazhenka-todos.json'; a.click(); URL.revokeObjectURL(url); });
      importTodosBtn && importTodosBtn.addEventListener('click', ()=> todoImportFile.click());
      todoImportFile && todoImportFile.addEventListener('change', e=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev => { try{ const data = JSON.parse(ev.target.result); if(Array.isArray(data)){ const ids = new Set(todos.map(t=>t.id)); data.forEach(it=>{ if(!it.id) it.id=newTodoId(); if(!ids.has(it.id)) todos.push(it); }); saveTodos(todos); alert('Импорт завершён'); } else alert('Неверный формат'); }catch(err){ alert('Ошибка импорта'); } }; reader.readAsText(f); e.target.value=''; });
      clearCompletedBtn && clearCompletedBtn.addEventListener('click', ()=>{ todos = todos.filter(t=>!t.done); saveTodos(todos); });
      clearAllBtn && clearAllBtn.addEventListener('click', ()=>{ if(confirm('Удалить все задачи?')){ todos = []; saveTodos(todos); } });
      bulkCompleteBtn && bulkCompleteBtn.addEventListener('click', ()=>{ todos.forEach(t=>t.done=true); saveTodos(todos); });
      todoFilter && todoFilter.addEventListener('input', renderTodos); todoSort && todoSort.addEventListener('change', renderTodos);

      // Search & refresh
      searchReleases && searchReleases.addEventListener('input', ()=>{ renderReleasesGrouped(); renderModulesGrouped(); });
      filterType && filterType.addEventListener('change', ()=>{ renderReleasesGrouped(); renderModulesGrouped(); });
      sortBy && sortBy.addEventListener('change', ()=>{ renderReleasesGrouped(); renderModulesGrouped(); });
      includeStrato && includeStrato.addEventListener('change', ()=>{ try{ localStorage.removeItem(cacheKey); }catch(e){} loadReleases(); });
      refreshAllBtn && refreshAllBtn.addEventListener('click', ()=>{ try{ localStorage.removeItem(cacheKey); }catch(e){} loadAll(); });

      // Crew add/export/import (already wired above)
      addCrewBtn && addCrewBtn.addEventListener('click', ()=>{ /* handled earlier */ });

    })();
  </script>
</body>
</html>
