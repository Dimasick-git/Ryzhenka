<!DOCTYPE html>
<html lang="ru" data-theme="glow">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ryazhenka — агрегация релизов</title>
  <style>
    :root{ --bg:#071018; --card-bg:rgba(255,255,255,0.02); --accent:#7c5cff; --muted:#9aa0a6 }
    html[data-theme="classic"]{ --bg:#0f1724; --accent:#3ddc84 }
    html[data-theme="solarized"]{ --bg:#002b36; --accent:#b58900 }
    html[data-theme="neon"]{ --bg:#071018; --accent:#00ffd5 }
    html,body{height:100%;margin:0;background:var(--bg);color:#e7eef6;font-family:Inter,system-ui,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    header.wrap{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .logo{width:56px;height:56px}
    .muted{color:var(--muted)}
    .hero{padding:1rem;border-radius:10px;margin-bottom:1rem}
    .controls{display:flex;gap:.5rem;align-items:center}
    .btn{padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#39d6ff);border:0;color:#071018}
    .releases{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.75rem}
    .release-card{background:var(--card-bg);padding:1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .release-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
    .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-top:.75rem}
    .gallery img{width:100%;height:140px;object-fit:cover;border-radius:8px}
    .firmware-block{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:.75rem}
    .firmware-card{padding:1rem;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
    .muted.small{font-size:0.9rem;color:var(--muted)}
    @media(max-width:720px){ .releases{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))} }
  </style>
</head>
<body>
  <header class="wrap">
    <div style="display:flex;gap:.75rem;align-items:center">
      <img class="logo" src="./assets/Ryazhalogo.png" alt="Ryazhenka" />
      <!DOCTYPE html>
      <html lang="ru" data-theme="glow">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Ryazhenka — релизы (агрегатор)</title>
        <style>
          :root{ --bg:#071018; --card-bg:rgba(255,255,255,0.02); --accent:#7c5cff; --muted:#9aa0a6 }
          html[data-theme="classic"]{ --bg:#0f1724; --accent:#3ddc84 }
          html[data-theme="solarized"]{ --bg:#002b36; --accent:#b58900 }
          html[data-theme="neon"]{ --bg:#071018; --accent:#00ffd5 }
          html,body{height:100%;margin:0;background:var(--bg);color:#e7eef6;font-family:Inter,system-ui,Arial}
          .wrap{max-width:1100px;margin:0 auto;padding:1rem}
          header.wrap{display:flex;align-items:center;justify-content:space-between;gap:1rem}
          .logo{width:56px;height:56px}
          .muted{color:var(--muted)}
          .hero{padding:1rem;border-radius:10px;margin-bottom:1rem}
          .controls{display:flex;gap:.5rem;align-items:center}
          .btn{padding:.4rem .6rem;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
          .btn.primary{background:linear-gradient(90deg,var(--accent),#39d6ff);border:0;color:#071018}
          .releases{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.75rem}
          .release-card{background:var(--card-bg);padding:1rem;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
          .release-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
          .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-top:.75rem}
          .gallery img{width:100%;height:140px;object-fit:cover;border-radius:8px}
          .firmware-block{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:.75rem}
          .firmware-card{padding:1rem;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
          .muted.small{font-size:0.9rem;color:var(--muted)}
          @media(max-width:720px){ .releases{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))} }
        </style>
      </head>
      <body>
        <header class="wrap">
          <div style="display:flex;gap:.75rem;align-items:center">
            <img class="logo" src="./assets/Ryazhalogo.png" alt="Ryazhenka" />
            <div>
              <div style="font-weight:700">Ryazhenka — релизы</div>
              <div class="muted small">Агрегатор релизов — Dimasick-git</div>
            </div>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center">
            <button id="themeBtn" class="btn">Тема</button>
            <a class="btn" href="https://github.com/Dimasick-git/Ryzhenka" target="_blank">GitHub</a>
            <a class="btn" href="https://github.com/Dimasick-git/Ryzhenka/wiki" target="_blank">Wiki</a>
            <a class="btn" href="https://www.youtube.com/@Dimaick-git" target="_blank">YouTube</a>
          </div>
        </header>

        <main class="wrap">
          <section class="hero">
            <h1>Релизы Ryazhenka и популярных компонентов</h1>
            <div class="muted small">Если релизы не отображаются — откройте файл через локальный HTTP-сервер (например: python -m http.server 8000)</div>
          </section>

          <section id="controls" class="wrap">
            <div class="controls">
              <input id="searchReleases" placeholder="Поиск релизов" style="padding:.4rem;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)" />
              <button id="refreshReleases" class="btn">Обновить</button>
              <label style="display:flex;align-items:center;gap:.4rem"><input type="checkbox" id="autoRefresh" checked /> Автообновление</label>
              <div id="lastUpdated" class="muted small">Обновлено: —</div>
              <div id="fetchStatus" class="muted small" style="margin-left:8px">Статус: —</div>
            </div>
          </section>

          <section id="firmware">
            <h2>Прошивка Ryazhenka</h2>
            <div id="firmwareBlock" class="firmware-block"></div>
            <div style="margin-top:.5rem"><button id="downloadLatest" class="btn primary">Скачать последнюю</button> <span id="latestInfo" class="muted small">—</span></div>
          </section>

          <section id="repos">
            <h2>Релизы по репозиториям</h2>
            <div id="reposBlock"></div>
          </section>

          <section id="gallerySection">
            <h2>Галерея</h2>
            <div id="galleryGrid" class="gallery"></div>
          </section>

          <section id="releases">
            <h2>Все релизы</h2>
            <div id="releases-list" class="releases"></div>
          </section>

          <footer style="margin-top:2rem" class="muted small">Открыть через локальный сервер: в PowerShell — python -m http.server 8000</footer>
        </main>

        <script>
        (function(){
          // Configuration
          const OWNER = 'Dimasick-git';
          const REPO = 'Ryzhenka';
          const releasesApi = `https://api.github.com/repos/${OWNER}/${REPO}/releases?per_page=100`;
          const popularComponents = [
            { owner: 'Atmosphere-NX', repo: 'Atmosphere' },
            { owner: 'CTCaer', repo: 'hekate' },
            { owner: 'switchbrew', repo: 'libnx' },
            { owner: 'yifanlu', repo: 'Tesla' }
          ];

          // Elements
          const els = {
            list: document.getElementById('releases-list'),
            gallery: document.getElementById('galleryGrid'),
            firmware: document.getElementById('firmwareBlock'),
            repos: document.getElementById('reposBlock'),
            fetchStatus: document.getElementById('fetchStatus'),
            lastUpdated: document.getElementById('lastUpdated'),
            downloadLatest: document.getElementById('downloadLatest'),
            latestInfo: document.getElementById('latestInfo')
          };

          let releasesData = [];

          function logStatus(txt){ if(els.fetchStatus) els.fetchStatus.textContent = 'Статус: ' + txt; console.debug('[rz]', txt); }
          function fmtDate(d){ if(!d) return ''; try{ return new Date(d).toLocaleDateString('ru-RU'); }catch(e){ return d; } }

          function extractImageFromBody(body){ if(!body) return null; try{ const m = body.match(/https?:\/\/(?:[^\s'"()])+\.(?:png|jpe?g|gif|webp)/i); return m? m[0]: null; }catch(e){ return null; } }

          async function fetchJson(url){ const r = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' } }); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }

          async function loadOwnerReleases(user, limit=40, perRepo=3){ try{ const repos = await fetchJson(`https://api.github.com/users/${user}/repos?per_page=100&type=owner`); const sel = repos.slice(0, limit); const out = []; for(const r of sel){ try{ const rels = await fetchJson(`https://api.github.com/repos/${user}/${r.name}/releases?per_page=${perRepo}`); rels.forEach(rel=>{ rel.__source = `${user}/${r.name}`; out.push(rel); }); }catch(e){ /* ignore */ } } return out; }catch(e){ console.warn('owner releases', e); return []; } }

          async function loadReposReleases(list, perRepo=3){ const out = []; for(const it of list){ try{ const rels = await fetchJson(`https://api.github.com/repos/${it.owner}/${it.repo}/releases?per_page=${perRepo}`); rels.forEach(rel=>{ rel.__source = `${it.owner}/${it.repo}`; out.push(rel); }); }catch(e){ console.warn('repo fetch', it, e); } } return out; }

          function dedupeSort(list){ const seen = new Set(); const out=[]; list.sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at)); for(const it of list){ const key = it.html_url || (it.id?String(it.id):(it.tag_name||it.name||'')); if(!key) continue; if(seen.has(key)) continue; seen.add(key); out.push(it); } return out; }

          async function loadReleases(force=false){ const cacheKey = 'rz_cache_v4'; try{
              if(!force){ const c = localStorage.getItem(cacheKey); if(c){ const parsed = JSON.parse(c); if(Date.now()-parsed.ts < 1000*60*5){ releasesData = parsed.data || []; renderAll(); logStatus(`данные из кеша (${releasesData.length})`); return; } } }
              logStatus('загрузка…');
              const [own, comps, main] = await Promise.all([
                loadOwnerReleases(OWNER, 40, 3),
                loadReposReleases(popularComponents, 3),
                fetchJson(releasesApi).catch(()=>[])
              ]);
              const combined = [].concat(own||[], comps||[], main||[]);
              const ded = dedupeSort(combined);
              releasesData = ded.slice(0, 400);
              try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: releasesData })); }catch(e){/* ignore */}
              logStatus(`загружено ${releasesData.length} релизов`);
              if(els.lastUpdated) els.lastUpdated.textContent = 'Обновлено: ' + new Date().toLocaleString('ru-RU');
              renderAll();
            }catch(e){ console.error(e); logStatus('ошибка загрузки — см. консоль'); }
          }

          function makeCard(r){ const el=document.createElement('div'); el.className='release-card'; const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = r.name || r.tag_name || ''; el.appendChild(title); const meta=document.createElement('div'); meta.className='muted small'; meta.textContent = fmtDate(r.published_at||r.created_at) + (r.__source?(' • '+r.__source):''); el.appendChild(meta); if(r.body){ const p=document.createElement('p'); p.className='muted'; p.textContent = (r.body||'').slice(0,200); el.appendChild(p); } const imgAsset = (r.assets||[]).find(a=>/\.(png|jpe?g|gif|webp)$/i.test(a.name||'')); const bodyImg = extractImageFromBody(r.body); const src = imgAsset? imgAsset.browser_download_url : (bodyImg || ''); if(src){ const img = document.createElement('img'); img.src = src; img.alt = r.name || r.tag_name || ''; el.insertBefore(img, el.firstChild); } if(r.assets && r.assets.length){ const div=document.createElement('div'); r.assets.forEach(a=>{ const ael=document.createElement('a'); ael.href=a.browser_download_url; ael.target='_blank'; ael.className='btn'; ael.style.marginRight='6px'; ael.textContent = a.name + (a.download_count?(' ('+a.download_count+')'):''); div.appendChild(ael); }); el.appendChild(div); } return el; }

          function renderReleases(){ els.list.innerHTML=''; const q=document.getElementById('searchReleases').value.trim().toLowerCase(); const filtered = releasesData.filter(r=>{ const txt = ((r.name||'')+' '+(r.body||'')).toLowerCase(); return !q || txt.includes(q); }); if(filtered.length===0){ els.list.innerHTML='<div class="muted">Релизов не найдено.</div>'; return; } filtered.forEach(r=> els.list.appendChild(makeCard(r))); }

          function renderGallery(){ els.gallery.innerHTML=''; (releasesData||[]).forEach(r=>{ const assets=(r.assets||[]); let chosen=null; for(const a of assets){ if(/\.(gif|webp)$/i.test(a.name||'')){ chosen=a; break; } } if(!chosen){ for(const a of assets){ if(/\.(png|jpe?g|webp)$/i.test(a.name||'')){ chosen=a; break; } } } const bodyImg = extractImageFromBody(r.body); const src = chosen? chosen.browser_download_url : (bodyImg || ''); if(!src) return; const fig=document.createElement('figure'); fig.style.margin=0; const img=document.createElement('img'); img.src=src; img.alt=r.name||r.tag_name||''; img.loading='lazy'; fig.appendChild(img); const cap=document.createElement('figcaption'); cap.style.fontSize='0.9rem'; cap.style.marginTop='6px'; const a=document.createElement('a'); a.href = r.html_url || (r.__source?('https://github.com/'+r.__source):'#'); a.target='_blank'; a.textContent = r.name || r.tag_name || r.__source || ''; cap.appendChild(a); fig.appendChild(cap); fig.dataset.rdesc = (r.body||'').slice(0,1000); fig.dataset.rurl = r.html_url || (r.__source?('https://github.com/'+r.__source):''); els.gallery.appendChild(fig); }); }

          function renderFirmwareBlock(){ if(!els.firmware) return; els.firmware.innerHTML=''; const mine = (releasesData||[]).filter(r=> { const src = (r.__source||'').toLowerCase(); const repoOwner = (r.repository && r.repository.owner && (r.repository.owner.login||'')).toLowerCase(); return src.startsWith(OWNER.toLowerCase() + '/') || repoOwner === OWNER.toLowerCase(); }); if(mine.length===0){ els.firmware.innerHTML='<div class="muted">Релизов Ryazhenka не найдено.</div>'; return; } mine.slice(0,12).forEach(r=>{ const c=document.createElement('div'); c.className='firmware-card'; const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = r.name||r.tag_name||''; c.appendChild(title); const body=document.createElement('div'); body.className='muted small'; body.textContent=(r.body||'').slice(0,140); c.appendChild(body); if(r.assets&&r.assets.length){ const div=document.createElement('div'); r.assets.forEach(a=>{ const al=document.createElement('a'); al.className='btn'; al.href=a.browser_download_url; al.target='_blank'; al.textContent=a.name; al.style.marginRight='6px'; div.appendChild(al); }); c.appendChild(div); } els.firmware.appendChild(c); }); // wire download latest
            const relLatest = (releasesData||[]).find(r=> (r.__source||'').toLowerCase().startsWith(OWNER.toLowerCase()+'/')) || (releasesData[0]||null);
            if(els.downloadLatest && relLatest){ const mainAsset = (relLatest.assets||[]).find(a=>/\.(zip|tar|7z|nsp|xci|bin|img)$/i.test(a.name||'')) || (relLatest.assets&&relLatest.assets[0]) || null; if(mainAsset){ els.downloadLatest.onclick = ()=> window.open(mainAsset.browser_download_url,'_blank'); if(els.latestInfo) els.latestInfo.textContent = `${relLatest.name||relLatest.tag_name} • ${fmtDate(relLatest.published_at||relLatest.created_at)}`; } }
          }

          function renderRepoBlocks(){ if(!els.repos) return; els.repos.innerHTML=''; const groups={}; (releasesData||[]).forEach(r=>{ const key = r.__source || (r.repository && r.repository.full_name) || 'other'; groups[key]=groups[key]||[]; groups[key].push(r); }); Object.keys(groups).forEach(k=>{ const box=document.createElement('div'); const h=document.createElement('h3'); h.textContent=k; box.appendChild(h); const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(220px,1fr))'; grid.style.gap='0.6rem'; groups[k].slice(0,6).forEach(r=>{ grid.appendChild(makeCard(r)); }); box.appendChild(grid); els.repos.appendChild(box); }); }

          function renderAll(){ renderReleases(); renderGallery(); renderFirmwareBlock(); renderRepoBlocks(); }

          // lightbox for gallery
          (function(){ const modal=document.createElement('div'); modal.style.display='none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.7)'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='9999'; const inner=document.createElement('div'); inner.style.maxWidth='900px'; inner.style.width='90%'; inner.style.padding='1rem'; inner.style.background='var(--card-bg)'; inner.style.borderRadius='8px'; inner.style.overflow='auto'; const img=document.createElement('img'); img.style.width='100%'; img.style.borderRadius='6px'; const desc=document.createElement('div'); desc.style.marginTop='8px'; desc.className='muted'; const link=document.createElement('a'); link.style.display='inline-block'; link.style.marginTop='6px'; inner.appendChild(img); inner.appendChild(desc); inner.appendChild(link); modal.appendChild(inner); document.body.appendChild(modal); modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none'; }); document.addEventListener('click',(e)=>{ const fig = e.target.closest && e.target.closest('figure'); if(fig && fig.parentElement && fig.parentElement.id==='galleryGrid'){ e.preventDefault(); const i = fig.querySelector('img'); img.src = i.src; desc.textContent = fig.dataset.rdesc || ''; link.href = fig.dataset.rurl || '#'; link.textContent = link.href && link.href!=='#' ? 'Открыть релиз' : ''; modal.style.display='flex'; } }); })();

          // UI wiring
          document.getElementById('refreshReleases').addEventListener('click', ()=>loadReleases(true));
          document.getElementById('searchReleases').addEventListener('input', ()=>renderReleases());
          setInterval(()=>{ const auto = document.getElementById('autoRefresh'); if(!auto || auto.checked) loadReleases(false); }, 1000*60*2);

          // theme
          const THEMES = ['glow','classic','solarized','neon']; (function(){ const t=localStorage.getItem('rz_theme')||'glow'; document.documentElement.dataset.theme=t; const b=document.getElementById('themeBtn'); if(b) b.textContent='Тема: '+t; })(); document.getElementById('themeBtn').addEventListener('click', ()=>{ const cur = document.documentElement.dataset.theme||'glow'; const idx = THEMES.indexOf(cur); const next = THEMES[(idx+1)%THEMES.length]; document.documentElement.dataset.theme = next; localStorage.setItem('rz_theme', next); document.getElementById('themeBtn').textContent='Тема: '+next; });

          // initial load
          loadReleases(false);
        })();
        </script>
      </body>
      </html>

      function logStatus(txt){ if(els.fetchStatus) els.fetchStatus.textContent = 'Статус: ' + txt; console.debug('[rz]', txt); }
      function fmtDate(d){ if(!d) return ''; try{ return new Date(d).toLocaleDateString('ru-RU'); }catch(e){ return d; } }

      function extractImageFromBody(body){ if(!body) return null; try{ const m = body.match(/https?:\/\/(?:[^\s'"()])+\.(?:png|jpe?g|gif|webp)/i); return m? m[0]: null; }catch(e){ return null; } }

      async function fetchJson(url){ const r = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' } }); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }

      async function loadOwnerReleases(user, limit=40, perRepo=3){ try{ const repos = await fetchJson(`https://api.github.com/users/${user}/repos?per_page=100&type=owner`); const sel = repos.slice(0, limit); const out = []; for(const r of sel){ try{ const rels = await fetchJson(`https://api.github.com/repos/${user}/${r.name}/releases?per_page=${perRepo}`); rels.forEach(rel=>{ rel.__source = `${user}/${r.name}`; out.push(rel); }); }catch(e){ /* ignore */ } } return out; }catch(e){ console.warn('owner releases', e); return []; } }

      async function loadReposReleases(list, perRepo=3){ const out = []; for(const it of list){ try{ const rels = await fetchJson(`https://api.github.com/repos/${it.owner}/${it.repo}/releases?per_page=${perRepo}`); rels.forEach(rel=>{ rel.__source = `${it.owner}/${it.repo}`; out.push(rel); }); }catch(e){ console.warn('repo fetch', it, e); } } return out; }

      function dedupeSort(list){ const seen = new Set(); const out=[]; list.sort((a,b)=> new Date(b.published_at||b.created_at) - new Date(a.published_at||a.created_at)); for(const it of list){ const key = it.html_url || (it.id?String(it.id):(it.tag_name||it.name||'')); if(!key) continue; if(seen.has(key)) continue; seen.add(key); out.push(it); } return out; }

      async function loadReleases(force=false){ const cacheKey = 'rz_cache_v4'; try{
          if(!force){ const c = localStorage.getItem(cacheKey); if(c){ const parsed = JSON.parse(c); if(Date.now()-parsed.ts < 1000*60*5){ releasesData = parsed.data || []; renderAll(); logStatus(`данные из кеша (${releasesData.length})`); return; } } }
          logStatus('загрузка…');
          const [own, comps, main] = await Promise.all([
            loadOwnerReleases(OWNER, 40, 3),
            loadReposReleases(popularComponents, 3),
            fetchJson(releasesApi).catch(()=>[])
          ]);
          const combined = [].concat(own||[], comps||[], main||[]);
          const ded = dedupeSort(combined);
          releasesData = ded.slice(0, 400);
          try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: releasesData })); }catch(e){/* ignore */}
          logStatus(`загружено ${releasesData.length} релизов`);
          if(els.lastUpdated) els.lastUpdated.textContent = 'Обновлено: ' + new Date().toLocaleString('ru-RU');
          renderAll();
        }catch(e){ console.error(e); logStatus('ошибка загрузки — см. консоль'); }
      }

      function makeCard(r){ const el=document.createElement('div'); el.className='release-card'; const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = r.name || r.tag_name || ''; el.appendChild(title); const meta=document.createElement('div'); meta.className='muted small'; meta.textContent = fmtDate(r.published_at||r.created_at) + (r.__source?(' • '+r.__source):''); el.appendChild(meta); if(r.body){ const p=document.createElement('p'); p.className='muted'; p.textContent = (r.body||'').slice(0,200); el.appendChild(p); } const imgAsset = (r.assets||[]).find(a=>/\.(png|jpe?g|gif|webp)$/i.test(a.name||'')); const bodyImg = extractImageFromBody(r.body); const src = imgAsset? imgAsset.browser_download_url : (bodyImg || ''); if(src){ const img = document.createElement('img'); img.src = src; img.alt = r.name || r.tag_name || ''; el.insertBefore(img, el.firstChild); } if(r.assets && r.assets.length){ const div=document.createElement('div'); r.assets.forEach(a=>{ const ael=document.createElement('a'); ael.href=a.browser_download_url; ael.target='_blank'; ael.className='btn'; ael.style.marginRight='6px'; ael.textContent = a.name + (a.download_count?(' ('+a.download_count+')'):''); div.appendChild(ael); }); el.appendChild(div); } return el; }

      function renderReleases(){ els.list.innerHTML=''; const q=document.getElementById('searchReleases').value.trim().toLowerCase(); const filtered = releasesData.filter(r=>{ const txt = ((r.name||'')+' '+(r.body||'')).toLowerCase(); return !q || txt.includes(q); }); if(filtered.length===0){ els.list.innerHTML='<div class="muted">Релизов не найдено.</div>'; return; } filtered.forEach(r=> els.list.appendChild(makeCard(r))); }

      function renderGallery(){ els.gallery.innerHTML=''; (releasesData||[]).forEach(r=>{ const assets=(r.assets||[]); let chosen=null; for(const a of assets){ if(/\.(gif|webp)$/i.test(a.name||'')){ chosen=a; break; } } if(!chosen){ for(const a of assets){ if(/\.(png|jpe?g|webp)$/i.test(a.name||'')){ chosen=a; break; } } } const bodyImg = extractImageFromBody(r.body); const src = chosen? chosen.browser_download_url : (bodyImg || ''); if(!src) return; const fig=document.createElement('figure'); fig.style.margin=0; const img=document.createElement('img'); img.src=src; img.alt=r.name||r.tag_name||''; img.loading='lazy'; fig.appendChild(img); const cap=document.createElement('figcaption'); cap.style.fontSize='0.9rem'; cap.style.marginTop='6px'; const a=document.createElement('a'); a.href = r.html_url || (r.__source?('https://github.com/'+r.__source):'#'); a.target='_blank'; a.textContent = r.name || r.tag_name || r.__source || ''; cap.appendChild(a); fig.appendChild(cap); fig.dataset.rdesc = (r.body||'').slice(0,1000); fig.dataset.rurl = r.html_url || (r.__source?('https://github.com/'+r.__source):''); els.gallery.appendChild(fig); }); }

      function renderFirmwareBlock(){ if(!els.firmware) return; els.firmware.innerHTML=''; const mine = (releasesData||[]).filter(r=> { const src = (r.__source||'').toLowerCase(); const repoOwner = (r.repository && r.repository.owner && (r.repository.owner.login||'')).toLowerCase(); return src.startsWith(OWNER.toLowerCase() + '/') || repoOwner === OWNER.toLowerCase(); }); if(mine.length===0){ els.firmware.innerHTML='<div class="muted">Релизов Ryazhenka не найдено.</div>'; return; } mine.slice(0,12).forEach(r=>{ const c=document.createElement('div'); c.className='firmware-card'; const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = r.name||r.tag_name||''; c.appendChild(title); const body=document.createElement('div'); body.className='muted small'; body.textContent=(r.body||'').slice(0,140); c.appendChild(body); if(r.assets&&r.assets.length){ const div=document.createElement('div'); r.assets.forEach(a=>{ const al=document.createElement('a'); al.className='btn'; al.href=a.browser_download_url; al.target='_blank'; al.textContent=a.name; al.style.marginRight='6px'; div.appendChild(al); }); c.appendChild(div); } els.firmware.appendChild(c); }); // wire download latest
        const relLatest = (releasesData||[]).find(r=> (r.__source||'').toLowerCase().startsWith(OWNER.toLowerCase()+'/')) || (releasesData[0]||null);
        if(els.downloadLatest && relLatest){ const mainAsset = (relLatest.assets||[]).find(a=>/\.(zip|tar|7z|nsp|xci|bin|img)$/i.test(a.name||'')) || (relLatest.assets&&relLatest.assets[0]) || null; if(mainAsset){ els.downloadLatest.onclick = ()=> window.open(mainAsset.browser_download_url,'_blank'); if(els.latestInfo) els.latestInfo.textContent = `${relLatest.name||relLatest.tag_name} • ${fmtDate(relLatest.published_at||relLatest.created_at)}`; } }
      }

      function renderRepoBlocks(){ if(!els.repos) return; els.repos.innerHTML=''; const groups={}; (releasesData||[]).forEach(r=>{ const key = r.__source || (r.repository && r.repository.full_name) || 'other'; groups[key]=groups[key]||[]; groups[key].push(r); }); Object.keys(groups).forEach(k=>{ const box=document.createElement('div'); const h=document.createElement('h3'); h.textContent=k; box.appendChild(h); const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(220px,1fr))'; grid.style.gap='0.6rem'; groups[k].slice(0,6).forEach(r=>{ grid.appendChild(makeCard(r)); }); box.appendChild(grid); els.repos.appendChild(box); }); }

      function renderAll(){ renderReleases(); renderGallery(); renderFirmwareBlock(); renderRepoBlocks(); }

      // lightbox for gallery
      (function(){ const modal=document.createElement('div'); modal.style.display='none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.7)'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='9999'; const inner=document.createElement('div'); inner.style.maxWidth='900px'; inner.style.width='90%'; inner.style.padding='1rem'; inner.style.background='var(--card-bg)'; inner.style.borderRadius='8px'; inner.style.overflow='auto'; const img=document.createElement('img'); img.style.width='100%'; img.style.borderRadius='6px'; const desc=document.createElement('div'); desc.style.marginTop='8px'; desc.className='muted'; const link=document.createElement('a'); link.style.display='inline-block'; link.style.marginTop='6px'; inner.appendChild(img); inner.appendChild(desc); inner.appendChild(link); modal.appendChild(inner); document.body.appendChild(modal); modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none'; }); document.addEventListener('click',(e)=>{ const fig = e.target.closest && e.target.closest('figure'); if(fig && fig.parentElement && fig.parentElement.id==='galleryGrid'){ e.preventDefault(); const i = fig.querySelector('img'); img.src = i.src; desc.textContent = fig.dataset.rdesc || ''; link.href = fig.dataset.rurl || '#'; link.textContent = link.href && link.href!=='#' ? 'Открыть релиз' : ''; modal.style.display='flex'; } }); })();

      // UI wiring
      document.getElementById('refreshReleases').addEventListener('click', ()=>loadReleases(true));
      document.getElementById('searchReleases').addEventListener('input', ()=>renderReleases());
      setInterval(()=>{ const auto = document.getElementById('autoRefresh'); if(!auto || auto.checked) loadReleases(false); }, 1000*60*2);

      // theme
      const THEMES = ['glow','classic','solarized','neon']; (function(){ const t=localStorage.getItem('rz_theme')||'glow'; document.documentElement.dataset.theme=t; const b=document.getElementById('themeBtn'); if(b) b.textContent='Тема: '+t; })(); document.getElementById('themeBtn').addEventListener('click', ()=>{ const cur = document.documentElement.dataset.theme||'glow'; const idx = THEMES.indexOf(cur); const next = THEMES[(idx+1)%THEMES.length]; document.documentElement.dataset.theme = next; localStorage.setItem('rz_theme', next); document.getElementById('themeBtn').textContent='Тема: '+next; });

      // initial load
      loadReleases(false);
    })();
    </script>
  </body>
  </html>